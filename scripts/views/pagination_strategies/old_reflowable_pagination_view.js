Readium.Views.ReflowablePaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(){Readium.Views.PaginationViewBase.prototype.initialize.call(this);this.page_template=_.template($("#reflowing-page-template").html());this.section=this.model.getCurrentSection();this.model.on("repagination_event",this.renderPages,this);this.model.on("change:two_up",this.renderPages,this);this.model.on("change:mo_playing",this.renderMoPlaying,this);this.model.on("change:current_mo_frag",this.renderMoFragHighlight,
this);this.section.on("change:content",function(){this.render(!!this.render_to_last)},this)},destruct:function(){console.log("Reflowing paginator destructor called");Readium.Views.PaginationViewBase.prototype.destruct.call(this);this.model.off("repagination_event",this.renderPages);this.model.off("change:two_up",this.renderPages);this.model.off("change:mo_playing",this.renderMoPlaying);this.model.off("change:current_mo_frag",this.renderMoFragHighlight);this.section.off("change:content",this.render)},
buildDiv:function(a){var b=$("<div></div>");b.attr("class",a.body.className);b.attr("id",a.body.id);b.html(a.body.innerHTML);return b[0]},render:function(a){this.resetEl();var b=this.section.get("content");if(!b)return this.render_to_last=a,this;b=(new window.DOMParser).parseFromString(b,"text/xml");this.addStyleSheets(b);this.applyBindings(b);this.replaceContent(this.buildDiv(b));b=this.parseTriggers(b);this.applyTriggers(document,b);this.applySwitches(document);this.$("#container").html(this.page_template({page_num:1,
empty:!1}));var c=this;MathJax.Hub.Queue(["Delay",MathJax.Callback,8],["Typeset",MathJax.Hub],function(){c.renderPages();c.toggleTwoUp();a?c.model.goToLastPage():c.model.goToPage(1)});return this},renderMoPlaying:function(){$("#readium-content-container").toggleClass("mo-playing",!!this.model.get("mo_playing"))},renderMoFragHighlight:function(){this.$(".current-mo-content").toggleClass("current-mo-content",!1);var a=this.model.get("current_mo_frag");a&&this.$("#"+a).toggleClass("current-mo-content",
!0)},guessPageNumber:function(){var a;a=$("#readium-content-container").height()/$(".page").first().height();return a<1?1:Math.ceil(a)},needsMorePages:function(){var a=$(".page").last()[0].webkitRegionOverflow;if(a)return a==="overflow";var b=function(a){return a.outerHeight(!0)+a.offset().top},a=b(this.$(".page").last()),b=b($("#content-end"));return a<b},renderPages:function(){var a,b,c,e=this.model.get("two_up");c=this.guessPageNumber();b="";this.setUpMode();this.$("#readium-content-container").css("visibility",
"invisible");e&&(b+=this.page_template({page_num:0,empty:!0}));for(a=1;a<=c;a++)b+=this.page_template({page_num:a,empty:!1});for(this.$("#container").html(b);this.needsMorePages();)this.$("#container").append(this.page_template({page_num:a,empty:!1})),a+=1;e&&c%2===0&&(c+=1,this.$("#container").append(this.page_template({page_num:a,empty:!1})));this.model.changPageNumber(c);this.$("#readium-content-container").css("visibility","visible");this.changePage()},goToHashFragment:function(){var a=this.model.get("hash_fragment");
a&&(console.log("attempting to find "+a),a=this.findHashFragment(a),typeof a==="number"?(console.log("the fragment is on page "+a),this.model.goToPage(a)):console.log("could not find the frag"),this.model.set("hash_fragment",null))},findHashFragment:function(a){a=$("#"+a);if(a.length!==1)return null;for(var a=a.children().length>0?a.children()[0]:a[0],b=a.getBoundingClientRect().left,c=$(".page-wrap"),e=c.length,f,g,d=0;d<e;d++)if(f=c[d].style.left,c[d].style.left=100,g=a.getBoundingClientRect().left,
c[d].style.left=f,g-b>10)return d+1;return null}});
