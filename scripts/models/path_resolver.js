window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL;window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder;window.g_uid_hashed=null;function PathResolver(a){this.baseUrl=new URI(a)}function encode_utf8(a){return unescape(encodeURIComponent(a))}function string2Bin(a){for(var c=[],b=0;b<a.length;b++)c.push(a.charCodeAt(b)&255);return c}
function string2ArrayBuffer(a){for(var c=new ArrayBuffer(a.length),b=new Uint8Array(c),d=0;d<a.length;d++)b[d]=a.charCodeAt(d);return c}function bin2String(a){return String.fromCharCode.apply(String,a)}PathResolver.prototype.resolve=function(a){return(new URI(a)).resolve(this.baseUrl)};
var domToString=function(a){return(new XMLSerializer).serializeToString(a)},fixCssLinks=function(a,c){var a=a.replace(/@import\s+(?:url\()*(.+?)(?:\))*\s*;/g,"@import url($1);"),b=/url\s*\(\s*['"]*\s*/,d=/['"]*\s*\)/;return a.replace(/url\s*\(\s*.+?\s*\)/g,function(a){a=a.replace(b,"");a=a.replace(d,"");return"url('"+c.resolve(a)+"')"})},fixXhtmlLinks=function(a,c){var b,d,e=(new window.DOMParser).parseFromString(a,"text/xml"),f=function(a){$("["+a+"]",e).each(function(){b=$(this);d=b.attr(a);d=c.resolve(d);
b.attr(a,d)})};f("src");f("href");$("image",e).each(function(){b=$(this);d=b.attr("xlink:href");d=c.resolve(d);b.attr("xlink:href",d)});return domToString(e)},fixFonts=function(a){if(a.indexOf("OTTO")==0||a.indexOf("wOFF")==0)return a;else{for(var c=a.slice(0,1040),c=string2Bin(c),b=g_uid_hashed.length,d=0;d<1040;d++)c[d]^=g_uid_hashed[d%b];return bin2String(c)+a.slice(1040)}},getBinaryFileFixingStrategy=function(a,c){if(a.substr(-4)===".otf"||a.substr(-5)===".woff"||a.substr(-4)===".OTF"||a.substr(-5)===
".WOFF"){if(window.g_uid_hashed==null){var b=encode_utf8(c.trim()),b=window.Crypto.SHA1(b,{asBytes:!0});window.g_uid_hashed=b}return fixFonts}return null},getLinkFixingStrategy=function(a){return a.substr(-4)===".css"?fixCssLinks:a.substr(-5)===".html"||a.substr(-6)===".xhtml"?fixXhtmlLinks:a.substr(-4)===".xml"?fixXhtmlLinks:null},monkeyPatchUrls=function(a,c,b,d){var e,f,g=new PathResolver(a),i=function(a){a=f(a,g);writeBinEntry(e,a,c,b)};f=getBinaryFileFixingStrategy(a,d);if(f!=null)window.resolveLocalFileSystemURL(a,
function(a){e=a;readBinEntry(e,i,b)}),c();else{var h=getLinkFixingStrategy(a);if(h===null)c();else{var j=function(a){a=h(a,g);writeEntry(e,a,c,b)};window.resolveLocalFileSystemURL(a,function(a){e=a;readEntry(e,j,b)})}}},readEntry=function(a,c,b){a.file(function(a){var b=new FileReader;b.onloadend=function(){c(this.result)};b.readAsText(a)},b)},writeEntry=function(a,c,b,d){Readium.FileSystemApi(function(e){e.writeFile(a.fullPath,c,b,d)})},readBinEntry=function(a,c,b){a.file(function(a){var b=new FileReader;
b.onloadend=function(){c(this.result)};b.readAsBinaryString(a)},b)},writeBinEntry=function(a,c,b,d){a.createWriter(function(a){a.onwriteend=function(){b()};a.onerror=function(a){d(a)};var f=new BlobBuilder,g=string2ArrayBuffer(c);f.append(g);f=f.getBlob("image/jpeg");a.write(f)},d)};
