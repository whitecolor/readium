Readium.Models.MediaOverlay=Backbone.Model.extend({audioplayer:null,smilModel:null,defaults:{is_ready:!1,is_document_done:!1,is_playing:!1,should_highlight:!0,current_text_document_url:null,current_text_element_id:null,has_started_playback:!1},initialize:function(){var a=this;this.audioplayer=new Readium.Models.AudioClipPlayer;this.audioplayer.setConsoleTrace(!0);this.url=this.get("smil_url");this.audioplayer.setNotifyOnPause(function(){a.set({is_playing:a.audioplayer.isPlaying()})});this.audioplayer.setNotifyOnPlay(function(){a.set({is_playing:a.audioplayer.isPlaying()})})},
fetch:function(a){this.set({is_ready:!1});a||(a={});a.dataType="xml";Backbone.Model.prototype.fetch.call(this,a)},parse:function(a){var b=this;this.smilModel=new Readium.Models.SmilModel;this.smilModel.setUrl(this.get("smil_url"));this.smilModel.setNotifySmilDone(function(){b.set({is_document_done:!0})});this.smilModel.addRenderers({audio:function(){var a=this;b.audioplayer.setNotifyClipDone(function(){a.notifyChildDone()});var c=!1;if(this.hasOwnProperty("isJumpTarget"))c=this.isJumpTarget,this.isJumpTarget=
!1;b.audioplayer.play($(this).attr("src"),parseFloat($(this).attr("clipBegin")),parseFloat($(this).attr("clipEnd")),c)},text:function(){var a=$(this).attr("src");b.set({current_text_document_url:b.stripFragment(a),current_text_element_id:b.getFragment(a)})}});this.smilModel.build($(a).find("body")[0]);this.set({is_ready:!0})},startPlayback:function(a){this.get("is_ready")!=!1&&(this.set({is_document_done:!1}),this.set({has_started_playback:!0}),this.smilModel.render(a))},pause:function(){this.get("is_ready")!=
!1&&this.get("has_started_playback")!=!1&&this.audioplayer.pause()},resume:function(){this.get("is_ready")!=!1&&this.get("has_started_playback")!=!1&&this.audioplayer.resume()},findNodeByTextSrc:function(a){if(this.get("is_ready")!=!1){var b=this.smilModel.findNodeByAttrValue("text","src",a);b==null&&(b=this.smilModel.findNodeByAttrValue("seq","epub:textref",a));return b}},setVolume:function(a){this.get("is_ready")!=!1&&this.audioplayer.setVolume(a)},getFragment:function(a){return a.indexOf("#")!=
-1&&a.indexOf("#")<a.length-1?a.substr(a.indexOf("#")+1):""},stripFragment:function(a){return a.indexOf("#")==-1?a:a.substr(0,a.indexOf("#"))}});
