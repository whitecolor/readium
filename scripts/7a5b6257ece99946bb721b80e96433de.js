window.Readium={Models:{},Collections:{},Views:{},Routers:{},Utils:{},Init:function(){window.options=Readium.Models.ReadiumOptions.getInstance();window.optionsView=new Readium.Views.ReadiumOptionsView({model:window.options});window._library=new Readium.Collections.LibraryItems;window._lib_view=new Readium.Views.LibraryItemsView({collection:window._library});window._fp_view=new Readium.Views.FilePickerView({collection:window._library});window.router=new Readium.Routers.LibraryRouter({picker:window._fp_view});
Backbone.history.start({pushState:!1,root:"views/library.html"});_lawnchair=new Lawnchair(function(){this.all(function(a){window._library.reset(a)})});$("#block-view-btn").click(function(){$("#library-items-container").addClass("block-view").removeClass("row-view");Readium.Utils.setCookie("lib_view","block",1E3)});$("#row-view-btn").click(function(){$("#library-items-container").addClass("row-view").removeClass("block-view");Readium.Utils.setCookie("lib_view","row",1E3)})}};$(function(){window.Readium.Init()});
Readium.Utils.MD5=function(e){function h(a,b){var c,d,e,f,g;e=a&2147483648;f=b&2147483648;c=a&1073741824;d=b&1073741824;g=(a&1073741823)+(b&1073741823);return c&d?g^2147483648^e^f:c|d?g&1073741824?g^3221225472^e^f:g^1073741824^e^f:g^e^f}function i(a,b,c,d,e,f,g){a=h(a,h(h(b&c|~b&d,e),g));return h(a<<f|a>>>32-f,b)}function j(a,b,c,d,e,f,g){a=h(a,h(h(b&d|c&~d,e),g));return h(a<<f|a>>>32-f,b)}function k(a,b,d,c,e,f,g){a=h(a,h(h(b^d^c,e),g));return h(a<<f|a>>>32-f,b)}function l(a,b,d,c,e,f,g){a=h(a,h(h(d^
(b|~c),e),g));return h(a<<f|a>>>32-f,b)}function m(a){var b="",d="",c;for(c=0;c<=3;c++)d=a>>>c*8&255,d="0"+d.toString(16),b+=d.substr(d.length-2,2);return b}var f=[],n,o,p,q,a,b,c,d,e=function(a){for(var a=a.replace(/\r\n/g,"\n"),b="",d=0;d<a.length;d++){var c=a.charCodeAt(d);c<128?b+=String.fromCharCode(c):(c>127&&c<2048?b+=String.fromCharCode(c>>6|192):(b+=String.fromCharCode(c>>12|224),b+=String.fromCharCode(c>>6&63|128)),b+=String.fromCharCode(c&63|128))}return b}(e),f=function(a){var b,c=a.length;
b=c+8;for(var d=((b-b%64)/64+1)*16,e=Array(d-1),f=0,g=0;g<c;)b=(g-g%4)/4,f=g%4*8,e[b]|=a.charCodeAt(g)<<f,g++;e[(g-g%4)/4]|=128<<g%4*8;e[d-2]=c<<3;e[d-1]=c>>>29;return e}(e);a=1732584193;b=4023233417;c=2562383102;d=271733878;for(e=0;e<f.length;e+=16)n=a,o=b,p=c,q=d,a=i(a,b,c,d,f[e+0],7,3614090360),d=i(d,a,b,c,f[e+1],12,3905402710),c=i(c,d,a,b,f[e+2],17,606105819),b=i(b,c,d,a,f[e+3],22,3250441966),a=i(a,b,c,d,f[e+4],7,4118548399),d=i(d,a,b,c,f[e+5],12,1200080426),c=i(c,d,a,b,f[e+6],17,2821735955),
b=i(b,c,d,a,f[e+7],22,4249261313),a=i(a,b,c,d,f[e+8],7,1770035416),d=i(d,a,b,c,f[e+9],12,2336552879),c=i(c,d,a,b,f[e+10],17,4294925233),b=i(b,c,d,a,f[e+11],22,2304563134),a=i(a,b,c,d,f[e+12],7,1804603682),d=i(d,a,b,c,f[e+13],12,4254626195),c=i(c,d,a,b,f[e+14],17,2792965006),b=i(b,c,d,a,f[e+15],22,1236535329),a=j(a,b,c,d,f[e+1],5,4129170786),d=j(d,a,b,c,f[e+6],9,3225465664),c=j(c,d,a,b,f[e+11],14,643717713),b=j(b,c,d,a,f[e+0],20,3921069994),a=j(a,b,c,d,f[e+5],5,3593408605),d=j(d,a,b,c,f[e+10],9,38016083),
c=j(c,d,a,b,f[e+15],14,3634488961),b=j(b,c,d,a,f[e+4],20,3889429448),a=j(a,b,c,d,f[e+9],5,568446438),d=j(d,a,b,c,f[e+14],9,3275163606),c=j(c,d,a,b,f[e+3],14,4107603335),b=j(b,c,d,a,f[e+8],20,1163531501),a=j(a,b,c,d,f[e+13],5,2850285829),d=j(d,a,b,c,f[e+2],9,4243563512),c=j(c,d,a,b,f[e+7],14,1735328473),b=j(b,c,d,a,f[e+12],20,2368359562),a=k(a,b,c,d,f[e+5],4,4294588738),d=k(d,a,b,c,f[e+8],11,2272392833),c=k(c,d,a,b,f[e+11],16,1839030562),b=k(b,c,d,a,f[e+14],23,4259657740),a=k(a,b,c,d,f[e+1],4,2763975236),
d=k(d,a,b,c,f[e+4],11,1272893353),c=k(c,d,a,b,f[e+7],16,4139469664),b=k(b,c,d,a,f[e+10],23,3200236656),a=k(a,b,c,d,f[e+13],4,681279174),d=k(d,a,b,c,f[e+0],11,3936430074),c=k(c,d,a,b,f[e+3],16,3572445317),b=k(b,c,d,a,f[e+6],23,76029189),a=k(a,b,c,d,f[e+9],4,3654602809),d=k(d,a,b,c,f[e+12],11,3873151461),c=k(c,d,a,b,f[e+15],16,530742520),b=k(b,c,d,a,f[e+2],23,3299628645),a=l(a,b,c,d,f[e+0],6,4096336452),d=l(d,a,b,c,f[e+7],10,1126891415),c=l(c,d,a,b,f[e+14],15,2878612391),b=l(b,c,d,a,f[e+5],21,4237533241),
a=l(a,b,c,d,f[e+12],6,1700485571),d=l(d,a,b,c,f[e+3],10,2399980690),c=l(c,d,a,b,f[e+10],15,4293915773),b=l(b,c,d,a,f[e+1],21,2240044497),a=l(a,b,c,d,f[e+8],6,1873313359),d=l(d,a,b,c,f[e+15],10,4264355552),c=l(c,d,a,b,f[e+6],15,2734768916),b=l(b,c,d,a,f[e+13],21,1309151649),a=l(a,b,c,d,f[e+4],6,4149444226),d=l(d,a,b,c,f[e+11],10,3174756917),c=l(c,d,a,b,f[e+2],15,718787259),b=l(b,c,d,a,f[e+9],21,3951481745),a=h(a,n),b=h(b,o),c=h(c,p),d=h(d,q);return(m(a)+m(b)+m(c)+m(d)).toLowerCase()};
Readium.FileSystemApi=function(){var f,i=83886080,j=function(a){window.webkitRequestFileSystem(window.PERSITENT,i,function(b){f=b;a&&a(h)},d)},n=function(a){window.webkitStorageInfo.requestQuota(PERSISTENT,i,function(b){i=b;a(h)},function(b){console.log("Error",b);console.log("Exectution will not continue")})},d=function(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";
break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error: "+b)},k=function(a,b){if(b[0]=="."||b[0]=="")b=b.slice(1);a.getDirectory(b[0],{create:!0},function(a){b.length&&k(a,b.slice(1))},d)},o=function(a,b,c,g,e){c.getFile(a,{create:!1},function(d){d.remove(function(){l(a,b,c,g,e)})},function(){l(a,b,c,g,e)})},l=function(a,b,c,g,e){c.getFile(a,{create:!0,exclusive:!1},
function(a){a.createWriter(function(a){var c;a.onwriteend=function(a){g(a)};a.onerror=function(a){e(a)};if(b.webkitRelativePath||b.relativePath){var d=new FileReader;d.onload=function(b){c=new WebKitBlobBuilder;c.append(b.target.result);a.write(c.getBlob())};d.readAsArrayBuffer(b)}else c=new WebKitBlobBuilder,typeof b==="string"?(c.append(b),a.write(c.getBlob("text/plain"))):(d=new Uint8Array(b),c.append(d.buffer),a.write(c.getBlob()))},e)},e)},m=function(a,b,c,d,e){if(a[0]==="."||a[0]==="")a=a.slice(1);
a.length===1?o(a[0],b,c,d,e):c.getDirectory(a[0],{create:!0},function(c){a=a.slice(1);m(a,b,c,d,e)},e)},h={writeFile:function(a,b,c,d){a=a.split("/");m(a,b,f.root,c,d)},getFileSystem:function(){return f},readEntry:function(a,b,c){a.file(function(d){var e=new FileReader;e.onloadend=function(){this.result?b(this.result,a):c&&c()};e.readAsText(d)},c||d)},readTextFile:function(a,b,c){var g=this;f.root.getFile(a,{},function(a){g.readEntry(a,b,c)},c||d)},rmdir:function(a){f.root.getDirectory(a,{},function(a){a.removeRecursively(function(){console.log("Directory removed.")},
d)},d)},getFsUri:function(a,b,c){f.root.getFile(a,{create:!0,exclusive:!1},function(a){b(a.toURL())},c||d)},mkdir:k,genericFsErrorHandler:d};return function(a){if(f)return a(h),h;webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSITENT,function(b,c){c>0?j(a):n(function(){j(a)})})}}();
BBFileSystemSync=function(a,b,c){if(!b.file_path)throw"Cannot sync the model to the fs without a path";switch(a){case "read":Readium.FileSystemApi(function(a){a.readTextFile(b.file_path,function(a){c.success(a)},function(a){c.error(a)})});break;case "create":throw"Not yet implemented";case "update":throw"Not yet implemented";case "delete":throw"Not yet implemented";}return null};
Readium.Utils.Guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=Math.random()*16|0;return(d=="x"?b:b&3|8).toString(16)})};
Readium.Utils.LocalStorageAdaptor=function(d){var b,f=function(){localStorage.setItem(d,JSON.stringify(b))};return function(h,a,e){var c,g=localStorage.getItem(d);b=g&&JSON.parse(g)||{};switch(h){case "read":c=a.id?b[a.id]:_.values(b);break;case "create":if(!a.id)a.id=a.attributes.id=guid();b[a.id]=a;f();c=a;break;case "update":b[a.id]=a;f();c=a;break;case "delete":delete b[a.id],f(),c=a}c?e.success&&e.success(c):e.error&&e.error("Record not found")}};
Readium.Utils.setCookie=function(d,a,b){var c=new Date;c.setDate(c.getDate()+b);a=escape(a)+(b==null?"":"; expires="+c.toUTCString());document.cookie=d+"="+a};Readium.Utils.getCookie=function(d){var a,b,c,e=document.cookie.split(";");for(a=0;a<e.length;a++)if(b=e[a].substr(0,e[a].indexOf("=")),c=e[a].substr(e[a].indexOf("=")+1),b=b.replace(/^\s+|\s+$/g,""),b==d)return unescape(c)};Readium.Utils.trimString=function(d){return d.replace(/^\s+|\s+$/g,"")};
Readium.Models.ManifestItem=Backbone.Model.extend({parseMetaTags:function(){if(typeof this.get("meta_width")==="undefined"){var a=(new window.DOMParser).parseFromString(this.get("content"),"text/xml").getElementsByName("viewport")[0];return a?(a=this.parseViewportTag(a),this.set({meta_width:a.width,meta_height:a.height}),{meta_width:a.width,meta_height:a.height}):null}},parseViewportTag:function(a){for(var a=a.getAttribute("content"),a=a.replace(/\s/g,""),a=a.split(","),b={},c,d=0;d<a.length;d++)c=
a[d].split("="),c.length===2&&(b[c[0]]=c[1]);b.width=parseFloat(b.width);b.height=parseFloat(b.height);return b},resolvePath:function(a){return this.collection.packageDocument.resolvePath(a)},resolveUri:function(a){return this.collection.packageDocument.resolveUri(a)},loadContent:function(){var a=this,b=this.resolvePath(this.get("href"));Readium.FileSystemApi(function(c){c.readTextFile(b,function(b){a.set({content:b})},function(){console.log("Failed to load file: "+b)})})}});
Readium.Models.SpineItem=Readium.Models.ManifestItem.extend({initialize:function(){if(this.isFixedLayout())this.on("change:content",this.parseMetaTags,this);this.loadContent()},buildSectionJSON:function(a,b){if(!a)return null;var c=Object.create(null);c.width=this.get("meta_width")||0;c.height=this.get("meta_height")||0;c.uri=this.packageDocument.resolveUri(a.get("href"));c.page_class=this.getPositionClass(a,b);return c},toJSON:function(){this.isFixedLayout()&&this.parseMetaTags();var a={};a.width=
this.get("meta_width")||0;a.height=this.get("meta_height")||0;a.uri=this.resolveUri(this.get("href"));a.page_class=this.getPositionClass();return a},getPositionClass:function(){var a=this.collection.packageDocument.get("book"),b=this.get("spine_index");return a.get("apple_fixed")?b===0?"center_page":b%2===1&&b===this.collection.length?"center_page":b%2===0?"right_page":"left_page":b%2===0?"right_page":"left_page"},isFixedLayout:function(){return typeof this.get("fixed_flow")!=="undefined"?this.get("fixed_flow"):
this.collection.isBookFixedLayout()},getPageView:function(){if(!this.view)this.view=new Readium.Views.FixedPageView({model:this});return this.view},hasMediaOverlay:function(){return!!this.get("media_overlay")&&!!this.getMediaOverlay()},getMediaOverlay:function(){return this.collection.getMediaOverlay(this.get("media_overlay"))}});Readium.Collections.ManifestItems=Backbone.Collection.extend({model:Readium.Models.ManifestItem,initialize:function(a,b){this.packageDocument=b.packageDocument}});
Readium.Collections.Spine=Backbone.Collection.extend({model:Readium.Models.SpineItem,initialize:function(a,b){this.packageDocument=b.packageDocument},isBookFixedLayout:function(){return this.packageDocument.get("book").isFixedLayout()},getMediaOverlay:function(a){return this.packageDocument.getMediaOverlayItem(a)}});
Readium.Models.PackageDocumentBase=Backbone.Model.extend({initialize:function(a,b){if(b&&b.file_path){this.file_path=b.file_path;var c=this;b.root_url?c.uri_obj=new URI(b.root_url):Readium.FileSystemApi(function(a){a.getFsUri(c.file_path,function(a){c.uri_obj=new URI(a)})})}},jath_template:{metadata:{id:"//def:metadata/dc:identifier",epub_version:"//def:package/@version",title:"//def:metadata/dc:title",author:"//def:metadata/dc:creator",publisher:"//def:metadata/dc:publisher",description:"//def:metadata/dc:description",
rights:"//def:metadata/dc:rights",language:"//def:metadata/dc:language",pubdate:"//def:metadata/dc:date",modified_date:"//def:metadata/def:meta[@property='dcterms:modified']",layout:"//def:metadata/def:meta[@property='rendition:layout']",spread:"//def:metadata/def:meta[@property='rendition:spread']",orientation:"//def:metadata/def:meta[@property='rendition:orientation']",ncx:"//def:spine/@toc",page_prog_dir:"//def:spine/@page-progression-direction"},manifest:["//def:item",{id:"@id",href:"@href",media_type:"@media-type",
properties:"@properties",media_overlay:"@media-overlay"}],spine:["//def:itemref",{idref:"@idref",properties:"@properties"}],bindings:["//def:bindings/def:mediaType",{handler:"@handler",media_type:"@media-type"}]},getCoverHref:function(a){var b,c;b=a.getElementsByTagName("manifest")[0];c=$('item[properties~="cover-image"]',b);if(c.length===1&&c.attr("href"))return c.attr("href");a=$('meta[name="cover"]',a);c=a.attr("content");if(a.length===1&&c&&(c=$('item[id="'+c+'"]',b),c.length===1&&c.attr("href")))return c.attr("href");
c=$("#cover",b);return c.length===1&&c.attr("href")?c.attr("href"):null},parseSpineProperties:function(a){for(var b=function(a){for(var b={},a=a.split(" "),c=0;c<a.length;c++){if(a[c]==="rendition:page-spread-center")b.page_spread="center";if(a[c]==="page-spread-left")b.page_spread="left";if(a[c]==="page-spread-right")b.page_spread="right";if(a[c]==="page-spread-right")b.page_spread="right";if(a[c]==="rendition:layout-reflowable")b.fixed_flow=!1;if(a[c]==="rendition:layout-pre-paginated")b.fixed_flow=
!0}return b},c=0;c<a.length;c++){var d=b(a[c].properties);_.extend(a[c],d)}return a},resolveMediaOverlays:function(a){var b=this,c={};a.forEach(function(a){if(a.get("media_type")==="application/smil+xml"){var e=b.resolveUri(a.get("href")),e=new Readium.Models.MediaOverlay({smil_url:e});e.fetch();c[a.id]=e}});return c},paginateBackwards:function(a){return $("spine",a).attr("page-progression-direction")==="ltr"},parse:function(a){var b;typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,
"text/xml"));Jath.resolver=function(a){return{def:"http://www.idpf.org/2007/opf",dc:"http://purl.org/dc/elements/1.1/"}[a]};b=Jath.parse(this.jath_template,a);b.paginate_backwards=this.paginateBackwards(a);if(a=this.getCoverHref(a))b.metadata.cover_href=this.resolveUri(a);if(b.metadata.layout==="pre-paginated")b.metadata.fixed_layout=!0;b.manifest=new Readium.Collections.ManifestItems(b.manifest,{packageDocument:this});b.mo_map=this.resolveMediaOverlays(b.manifest);b.spine=this.parseSpineProperties(b.spine);
return b},crunchSpine:function(a,b){var c=-1,d=_.map(a,function(a){c+=1;var d=b.find(function(b){if(b.get("id")===a.idref)return b});return _.extend({},a,d.attributes,{spine_index:c})});return new Readium.Collections.Spine(d,{packageDocument:this})},reset:function(a){this.set(this.parse(a))},resolveUri:function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()},resolvePath:function(a){var b=this.file_path,a=a.indexOf("../")===0?a.substr(3):a,c=b.lastIndexOf("/");return b.substr(0,c)+"/"+
a}});
Readium.Models.ValidatedPackageMetaData=Readium.Models.PackageDocumentBase.extend({initialize:function(a,b){Readium.Models.PackageDocumentBase.prototype.initialize.call(this,a,b);this.set("package_doc_path",this.file_path)},validate:function(){},defaults:{fixed_layout:!1,apple_fixed:!1,open_to_spread:!1,cover_href:"/images/library/missing-cover-image.png",created_at:new Date,updated_at:new Date,paginate_backwards:!1},parseIbooksDisplayOptions:function(a){var b=(new window.DOMParser).parseFromString(a,"text/xml"),
a=b.getElementsByName("fixed-layout")[0],b=b.getElementsByName("open-to-spread")[0];this.set({fixed_layout:a&&a.textContent.toLowerCase().trim()==="true",open_to_spread:b&&b.textContent.toLowerCase().trim()==="true",apple_fixed:a&&a.textContent.toLowerCase().trim()==="true"})},parse:function(a){return Readium.Models.PackageDocumentBase.prototype.parse.call(this,a).metadata},save:function(a,b){var c=this;this.set("updated_at",new Date);Lawnchair(function(){this.save(c.toJSON(),b.success)})}});
Readium.Models.PackageDocument=Readium.Models.PackageDocumentBase.extend({initialize:function(a,b){Readium.Models.PackageDocumentBase.prototype.initialize.call(this,a,b);this.on("change:spine_position",this.onSpinePosChanged)},onSpinePosChanged:function(){this.get("spine_position")>=this.previous("spine_position")?this.trigger("increased:spine_position"):this.trigger("decreased:spine_position")},validate:function(a){if(!a.manifest&&!this.get("manifest"))return"ERROR: All ePUBs must have a manifest";
var b=a.spine||this.get("spine");if(!b)return"ERROR: All ePUBs must have a spine";if(a.spine_position<0||a.spine_position>=b.length)return"ERROR: invalid spine position"},sync:BBFileSystemSync,defaults:{spine_position:0},getManifestItemById:function(a){return this.get("manifest").find(function(b){if(b.get("id")===a)return b})},getSpineItem:function(a){return this.get("res_spine").at(a)},spineLength:function(){return this.get("res_spine").length},goToNextSection:function(){this.set({spine_position:this.get("spine_position")+
1})},goToPrevSection:function(){this.set({spine_position:this.get("spine_position")-1})},spineIndexFromHref:function(a){for(var b=this.get("res_spine"),a=this.resolveUri(a).replace(/#.*$/,""),c=0;c<b.length;c++){var d=b.at(c).get("href"),d=this.resolveUri(d).replace(/#.*$/,"");if(d===a)return c}return-1},goToHref:function(a){var b=this.get("spine"),c=this.get("manifest"),d=this,a=d.resolveUri(a).replace(/#.*$/,""),c=c.find(function(b){var c=d.resolveUri(b.get("href")).replace(/#.*$/,"");if(a==c)return b});
if(!c)return null;for(var c=c.get("id"),e=0;e<b.length;++e)if(b[e].idref===c){this.set({spine_position:e},{silent:!0});this._previousAttributes.spine_position=0;this.trigger("change:spine_position");break}},getTocItem:function(){var a=this.get("manifest"),b=this.get("metadata").ncx,c=a.find(function(a){return a.get("properties")==="nav"});return c?c:b&&b.length>0?a.find(function(a){return a.get("id")===b}):null},getMediaOverlayItem:function(a){var b=this.get("mo_map");return b&&b[a]},parse:function(a){a=
Readium.Models.PackageDocumentBase.prototype.parse.call(this,a);a.res_spine=this.crunchSpine(a.spine,a.manifest);return a}});
window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL;window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder;window.g_uid_hashed=null;function PathResolver(a){this.baseUrl=new URI(a)}function encode_utf8(a){return unescape(encodeURIComponent(a))}function string2Bin(a){for(var c=[],b=0;b<a.length;b++)c.push(a.charCodeAt(b)&255);return c}
function string2ArrayBuffer(a){for(var c=new ArrayBuffer(a.length),b=new Uint8Array(c),d=0;d<a.length;d++)b[d]=a.charCodeAt(d);return c}function bin2String(a){return String.fromCharCode.apply(String,a)}PathResolver.prototype.resolve=function(a){return(new URI(a)).resolve(this.baseUrl)};
var domToString=function(a){return(new XMLSerializer).serializeToString(a)},fixCssLinks=function(a,c){var a=a.replace(/@import\s+(?:url\()*(.+?)(?:\))*\s*;/g,"@import url($1);"),b=/url\s*\(\s*['"]*\s*/,d=/['"]*\s*\)/;return a.replace(/url\s*\(\s*.+?\s*\)/g,function(a){a=a.replace(b,"");a=a.replace(d,"");return"url('"+c.resolve(a)+"')"})},fixXhtmlLinks=function(a,c){var b,d,e=(new window.DOMParser).parseFromString(a,"text/xml"),f=function(a){$("["+a+"]",e).each(function(){b=$(this);d=b.attr(a);d=c.resolve(d);
b.attr(a,d)})};f("src");f("href");$("image",e).each(function(){b=$(this);d=b.attr("xlink:href");d=c.resolve(d);b.attr("xlink:href",d)});return domToString(e)},fixFonts=function(a){if(a.indexOf("OTTO")==0||a.indexOf("wOFF")==0)return a;else{for(var c=a.slice(0,1040),c=string2Bin(c),b=g_uid_hashed.length,d=0;d<1040;d++)c[d]^=g_uid_hashed[d%b];return bin2String(c)+a.slice(1040)}},getBinaryFileFixingStrategy=function(a,c){if(a.substr(-4)===".otf"||a.substr(-5)===".woff"||a.substr(-4)===".OTF"||a.substr(-5)===
".WOFF"){if(window.g_uid_hashed==null){var b=encode_utf8(c.trim()),b=window.Crypto.SHA1(b,{asBytes:!0});window.g_uid_hashed=b}return fixFonts}return null},getLinkFixingStrategy=function(a){return a.substr(-4)===".css"?fixCssLinks:a.substr(-5)===".html"||a.substr(-6)===".xhtml"?fixXhtmlLinks:a.substr(-4)===".xml"?fixXhtmlLinks:null},monkeyPatchUrls=function(a,c,b,d){var e,f,g=new PathResolver(a),i=function(a){a=f(a,g);writeBinEntry(e,a,c,b)};f=getBinaryFileFixingStrategy(a,d);if(f!=null)window.resolveLocalFileSystemURL(a,
function(a){e=a;readBinEntry(e,i,b)}),c();else{var h=getLinkFixingStrategy(a);if(h===null)c();else{var j=function(a){a=h(a,g);writeEntry(e,a,c,b)};window.resolveLocalFileSystemURL(a,function(a){e=a;readEntry(e,j,b)})}}},readEntry=function(a,c,b){a.file(function(a){var b=new FileReader;b.onloadend=function(){c(this.result)};b.readAsText(a)},b)},writeEntry=function(a,c,b,d){Readium.FileSystemApi(function(e){e.writeFile(a.fullPath,c,b,d)})},readBinEntry=function(a,c,b){a.file(function(a){var b=new FileReader;
b.onloadend=function(){c(this.result)};b.readAsBinaryString(a)},b)},writeBinEntry=function(a,c,b,d){a.createWriter(function(a){a.onwriteend=function(){b()};a.onerror=function(a){d(a)};var f=new BlobBuilder,g=string2ArrayBuffer(c);f.append(g);f=f.getBlob("image/jpeg");a.write(f)},d)};
Readium.Models.ReadiumOptions=Backbone.Model.extend({initialize:function(){this.set("id","singleton")},defaults:{hijack_epub_urls:!1,verbose_unpacking:!0,paginate_everything:!0},sync:Readium.Utils.LocalStorageAdaptor("READIUM_OPTIONS")},{getInstance:function(){var a=new Readium.Models.ReadiumOptions;a.fetch({error:function(){localStorage.setItem("READIUM_OPTIONS","");a.save()}});return a}});
Readium.FileSystemApi=function(){var f,i=83886080,j=function(a){window.webkitRequestFileSystem(window.PERSITENT,i,function(b){f=b;a&&a(h)},d)},n=function(a){window.webkitStorageInfo.requestQuota(PERSISTENT,i,function(b){i=b;a(h)},function(b){console.log("Error",b);console.log("Exectution will not continue")})},d=function(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";
break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error: "+b)},k=function(a,b){if(b[0]=="."||b[0]=="")b=b.slice(1);a.getDirectory(b[0],{create:!0},function(a){b.length&&k(a,b.slice(1))},d)},o=function(a,b,c,g,e){c.getFile(a,{create:!1},function(d){d.remove(function(){l(a,b,c,g,e)})},function(){l(a,b,c,g,e)})},l=function(a,b,c,g,e){c.getFile(a,{create:!0,exclusive:!1},
function(a){a.createWriter(function(a){var c;a.onwriteend=function(a){g(a)};a.onerror=function(a){e(a)};if(b.webkitRelativePath||b.relativePath){var d=new FileReader;d.onload=function(b){c=new WebKitBlobBuilder;c.append(b.target.result);a.write(c.getBlob())};d.readAsArrayBuffer(b)}else c=new WebKitBlobBuilder,typeof b==="string"?(c.append(b),a.write(c.getBlob("text/plain"))):(d=new Uint8Array(b),c.append(d.buffer),a.write(c.getBlob()))},e)},e)},m=function(a,b,c,d,e){if(a[0]==="."||a[0]==="")a=a.slice(1);
a.length===1?o(a[0],b,c,d,e):c.getDirectory(a[0],{create:!0},function(c){a=a.slice(1);m(a,b,c,d,e)},e)},h={writeFile:function(a,b,c,d){a=a.split("/");m(a,b,f.root,c,d)},getFileSystem:function(){return f},readEntry:function(a,b,c){a.file(function(d){var e=new FileReader;e.onloadend=function(){this.result?b(this.result,a):c&&c()};e.readAsText(d)},c||d)},readTextFile:function(a,b,c){var g=this;f.root.getFile(a,{},function(a){g.readEntry(a,b,c)},c||d)},rmdir:function(a){f.root.getDirectory(a,{},function(a){a.removeRecursively(function(){console.log("Directory removed.")},
d)},d)},getFsUri:function(a,b,c){f.root.getFile(a,{create:!0,exclusive:!1},function(a){b(a.toURL())},c||d)},mkdir:k,genericFsErrorHandler:d};return function(a){if(f)return a(h),h;webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSITENT,function(b,c){c>0?j(a):n(function(){j(a)})})}}();
if(typeof Readium.FileSystemApi==="undefined")throw"ExtractBook holds Readium::FileSystemApi as a dependency";if(typeof Readium.Utils.MD5==="undefined")throw"Extract holds Readium::Utils::MD5 as a dependency";
Readium.Models.BookExtractorBase=Backbone.Model.extend({MIMETYPE:"mimetype",CONTAINER:"META-INF/container.xml",EPUB3_MIMETYPE:"application/epub+zip",DISPLAY_OPTIONS:"META-INF/com.apple.ibooks.display-options.xml",defaults:{task_size:100,progress:1,extracting:!1,log_message:"Fetching epub file"},clean:function(){this.removeHandlers();this.fsApi&&this.fsApi.rmdir(this.base_dir_name)},parseContainerRoot:function(a){var b=this.get("root_file_path");this.packageDoc=new Readium.Models.ValidatedPackageMetaData({key:this.base_dir_name,
src_url:this.get("src")},{file_path:this.base_dir_name+"/"+b,root_url:this.get("root_url")+"/"+b});this.packageDoc.reset(a);this.trigger("parsed:root_file")},writeFile:function(a,b,c){var d=this,e=this.base_dir_name+"/"+a;a.indexOf(this.DISPLAY_OPTIONS)>=0&&(typeof b==="string"?this.packageDoc.parseIbooksDisplayOptions(b):this.readEntryByShortName(this.DISPLAY_OPTIONS,function(a){d.packageDoc.parseIbooksDisplayOptions(a)}));this.fsApi.writeFile(e,b,c,function(){d.set("error","ERROR: while writing to filesystem")})},
parseMetaInfo:function(a){a=(new window.DOMParser).parseFromString(a,"text/xml").getElementsByTagName("rootfile");a.length!==1?this.set("error","Error processing "+CONTAINER):a[0].hasAttribute("full-path")?this.set("root_file_path",a[0].attributes["full-path"].value):this.set("error","Error: could not find package rootfile")},validateMimetype:function(a){$.trim(a)===this.EPUB3_MIMETYPE?this.trigger("validated:mime"):this.set("error","Invalid mimetype discovered. Progress cancelled.")},removeHandlers:function(){this.off()},
extraction_complete:function(){this.set("extracting",!1)},finish_extraction:function(){var a=this;this.set("log_message","Unpacking process completed successfully!");this.packageDoc.save({},{success:function(){a.trigger("extraction_success")},failure:function(){a.set("failure","ERROR: unknown problem during unpacking process")}})},correctURIs:function(){var a=this.get("root_url"),b=this.get("patch_position"),c=this.get("manifest"),d=this.packageDoc.get("id"),e=this;b>=c.length?(this.off("change:patch_position"),
this.finish_extraction()):(this.set("log_message","monkey patching: "+c[b]),monkeyPatchUrls(a+"/"+c[b],function(){e.incPatchPos()},function(){e.set("failure","ERROR: unknown problem during unpacking process")},d))},incPatchPos:function(){var a=this.get("patch_position")||0;a+=1;this.set("patch_position",a)}});
Readium.Models.ZipBookExtractor=Readium.Models.BookExtractorBase.extend({initialize:function(){var a=this.get("url");if(a)this.base_dir_name=Readium.Utils.MD5(a+(new Date).toString()),this.set("src",this.get("src_filename"));else throw"A URL to a zip file must be specified";},extractEntryByName:function(a,b){for(var c=!1,d=0;d<this.zip.entries.length;d++)if(this.zip.entries[d].name===a){c=!0;this.zip.entries[d].extract(b);break}if(!c)throw"asked to extract non-existent zip-entry: "+a;},extractContainerRoot:function(){var a=
this,b=this.get("root_file_path");try{this.extractEntryByName(b,function(b,c){a.parseContainerRoot(c)})}catch(c){this.set("error",c)}},extractMetaInfo:function(){var a=this;try{this.extractEntryByName(this.CONTAINER,function(b,d){a.parseMetaInfo(d)})}catch(b){this.set("error",b)}},extractMimetype:function(){var a=this;this.set("log_message","Verifying mimetype");try{this.extractEntryByName(this.MIMETYPE,function(b,d){a.validateMimetype(d)})}catch(b){this.set("error",b)}},validateZip:function(){var a=
this.zip.entryNames;this.set("log_message","Validating zip file");a.indexOf(this.MIMETYPE)>=0&&a.indexOf(this.CONTAINER)>=0?this.trigger("validated:zip"):this.set("error","File does not appear to be a valid EPUB. Progress cancelled.")},extractBook:function(){var a;a=this.zip;var b=this.get("zip_position"),c=this;b===a.entries.length?(this.set("log_message","All files unzipped successfully!"),this.set("patch_position",0)):(a=a.entries[b],a.name.substr(-1)==="/"?c.set("zip_position",b+1):(this.set("log_message",
"extracting: "+a.name),a.extract(function(a,e){c.writeFile(a.name,e,function(){c.set("zip_position",b+1)})})))},beginUnpacking:function(){for(var a=[],b,c=0;c<this.zip.entries.length;c++)b=this.zip.entries[c],b.name.substr(-1)!=="/"&&a.push(b.name);this.set("manifest",a);this.set("zip_position",0)},extract:function(){this.on("initialized:zip",this.validateZip,this);this.on("validated:zip",this.extractMimetype,this);this.on("validated:mime",this.extractMetaInfo,this);this.on("change:root_file_path",
this.extractContainerRoot,this);this.on("parsed:root_file",this.beginUnpacking,this);this.on("change:zip_position",this.extractBook,this);this.on("change:patch_position",this.correctURIs,this);this.on("change:failure",this.clean,this);this.on("change:failure",this.removeHandlers,this);this.on("change:task_size",this.update_progress,this);this.on("change:zip_position",this.update_progress,this);this.on("change:patch_position",this.update_progress,this);this.on("extraction_success",this.extraction_complete,
this);this.set("extracting",!0);var a=this;Readium.FileSystemApi(function(b){a.fsApi=b;a.initializeZip()})},update_progress:function(){var a=this.get("zip_position")||0,b=this.get("patch_position")||0;this.set("progress",Math.floor((a+b+3)*100/this.get("task_size")))},initializeZip:function(){var a=this;this.fsApi.getFileSystem().root.getDirectory(this.base_dir_name,{create:!0},function(b){a.set("root_url",b.toURL());a.zip=new ZipFile(a.get("url"),function(){a.set("task_size",a.zip.entries.length*
2+3);a.trigger("initialized:zip")},0)},function(){console.log("In beginUnpacking error handler. Does the root dir already exist?")})}});
Readium.Models.UnpackedBookExtractor=Readium.Models.BookExtractorBase.extend({initialize:function(){var a=this.get("dir_picker"),b=[],c;this.fNameStartInd=a.files[0].webkitRelativePath.indexOf("/")+1;this.base_dir_name=Readium.Utils.MD5("Banana"+(new Date).toString());this.fileList=a.files;for(a=0;c=this.fileList[a];++a)c=c.webkitRelativePath,c.substr(-2)!=="/."&&b.push(this.getShortName(c));this.set("src","Local Directory: "+this.fileList[0].webkitRelativePath.substring(0,this.fNameStartInd));this.set("task_size",
b.length*2+3);this.set("manifest",b)},getShortName:function(a){return a.substr(this.fNameStartInd)},update_progress:function(){var a=this.get("write_position")||0,b=this.get("patch_position")||0;this.set("progress",3+a+b)},extract:function(){this.on("validated:dir",this.readMime,this);this.on("validated:mime",this.readMetaInfo,this);this.on("change:root_file_path",this.readContainerRoot,this);this.on("parsed:root_file",this.beginWriting,this);this.on("change:write_position",this.writeEntry,this);
this.on("change:patch_position",this.correctURIs,this);this.on("change:failure",this.clean,this);this.on("change:failure",this.removeHandlers,this);this.on("change:task_size",this.update_progress,this);this.on("change:write_position",this.update_progress,this);this.on("change:patch_position",this.update_progress,this);this.on("extraction_success",this.extraction_complete,this);this.set("extracting",!0);var a=this;Readium.FileSystemApi(function(b){a.fsApi=b;b.getFileSystem().root.getDirectory(a.base_dir_name,
{create:!0},function(b){a.set("root_url",b.toURL());a.validateDir()})})},validateDir:function(){var a=this.get("manifest");a.indexOf(this.MIMETYPE)>=0&&a.indexOf(this.CONTAINER)>=0?this.trigger("validated:dir"):this.set("error","the directory you selected was not valid")},readMime:function(){var a=this;this.set("log_message","Verifying mimetype");try{this.readEntryByShortName(this.MIMETYPE,function(b){a.validateMimetype(b)})}catch(b){this.set("error",b)}},readMetaInfo:function(){var a=this;try{this.readEntryByShortName(this.CONTAINER,
function(b){a.parseMetaInfo(b)})}catch(b){this.set("error",b)}},readContainerRoot:function(){var a=this,b=this.get("root_file_path");try{this.readEntryByShortName(b,function(b){a.parseContainerRoot(b)})}catch(c){this.set("error",c)}},beginWriting:function(){this.set("write_position",0)},writeEntry:function(){var a=this,b=this.get("write_position");if(b===this.fileList.length)this.set("patch_position",0);else{var c=this.fileList[b],d=this.getShortName(c.webkitRelativePath);this.set("log_message","writing: "+
d);d.substr(-2)==="/."?this.set("write_position",b+1):this.writeFile(d,c,function(){a.set("write_position",b+1)})}},readEntryByShortName:function(a,b){for(var c=!1,d=this.get("dir_picker").files,e=0;e<d.length;e++)if(this.getShortName(d[e].webkitRelativePath)===a){var c=!0,f=new FileReader;f.onload=function(a){b(a.target.result)};f.readAsText(d[e]);break}if(!c)throw"asked to read non-existent file: "+a;}});
Readium.Routers.LibraryRouter=Backbone.Router.extend({initialize:function(a){this.picker=a.picker},routes:{options:"showOptions","/unpack/*url":"beginExtraction"},showOptions:function(){$("#readium-options-modal").modal("show")},beginExtraction:function(a){this.picker.beginExtraction(new Readium.Models.ZipBookExtractor({url:a,src_filename:a}))}});
Readium.Models.LibraryItem=Backbone.Model.extend({idAttribute:"key",getViewBookUrl:function(){return"/views/viewer.html?book="+this.get("key")},openInReader:function(){window.location=this.getViewBookUrl()},destroy:function(){var a=this.get("key");Lawnchair(function(){var b=this;this.get(a,function(c){c&&Readium.FileSystemApi(function(d){d.rmdir(c.key);b.remove(a)})})})}});Readium.Collections.LibraryItems=Backbone.Collection.extend({model:Readium.Models.LibraryItem});
Readium.Views.LibraryItemView=Backbone.View.extend({tagName:"div",className:"book-item clearfix",initialize:function(){this.template=_.template($("#library-item-template").html())},render:function(){var a=this.template({data:this.model.toJSON()});$(this.el).html(a);return this},events:{"click .delete":function(a){a.preventDefault();var b="#details-modal-"+this.model.get("key"),a="Are you sure you want to permanently delete ";a+=this.model.get("title");a+="?";confirm(a)&&($(b).modal("hide"),this.model.destroy(),
this.remove())},"click .read":function(){this.model.openInReader()}}});
Readium.Views.LibraryItemsView=Backbone.View.extend({tagName:"div",id:"library-items-container",className:"row-view clearfix",initialize:function(){this.template=_.template($("#library-items-template").html());this.collection.bind("reset",this.render,this);this.collection.bind("add",this.addOne,this)},render:function(){var a=this.collection,b=this.template({}),c=this.$el;c.html(b);this.$("#empty-message").toggle(a.isEmpty());a.each(function(b){b=new Readium.Views.LibraryItemView({model:b,collection:a,
id:b.get("id")});c.append(b.render().el)});this.restoreViewType();$("#library-books-list").html(this.el);return this},restoreViewType:function(){Readium.Utils.getCookie("lib_view")==="block"&&this.$el.addClass("block-view").removeClass("row-view")},addOne:function(a){a=new Readium.Views.LibraryItemView({model:a,collection:this.collection,id:a.get("id")});this.$("#empty-message").toggle(!1);$(this.el).append(a.render().el)},events:{}});
Readium.Views.ExtractItemView=Backbone.View.extend({el:"#progress-container",initialize:function(){this.template=_.template($("#extracting-item-template").html());this.model.bind("change",this.render,this);this.model.bind("change:error",this.extractionFailed,this)},render:function(){var a=$(this.el);this.model.get("extracting")?(a.html(this.template(this.model.toJSON())),a.show("slow")):a.hide("slow");return this},extractionFailed:function(){alert(this.model.get("error"));this.model.set("extracting",
!1)}});
Readium.Views.ReadiumOptionsView=Backbone.View.extend({el:"#readium-options-modal",initialize:function(){this.model.on("change",this.render,this);this.render()},render:function(){var a=this.model;this.$("#paginate_everything").prop("checked",a.get("paginate_everything"));this.$("#verbose_unpacking").prop("checked",a.get("verbose_unpacking"));this.$("#hijack_epub_urls").prop("checked",a.get("hijack_epub_urls"))},events:{"change #verbose_unpacking":"updateSettings","change #hijack_epub_urls":"updateSettings","change #paginate_everything":"updateSettings",
"click #save-settings-btn":"save"},updateSettings:function(){var a=this.$("#hijack_epub_urls").prop("checked"),b=this.$("#verbose_unpacking").prop("checked"),c=this.$("#paginate_everything").prop("checked");this.model.set({verbose_unpacking:b,hijack_epub_urls:a,paginate_everything:c})},save:function(){this.model.save();this.$el.modal("hide")}});
Readium.Views.FilePickerView=Backbone.View.extend({el:"#add-book-modal",events:{"change #files":"handleFileSelect","change #dir_input":"handleDirSelect","click #url-button":"handleUrl"},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")},resetForm:function(){},handleUrl:function(){var a=document.getElementById("book-url");a.value===null||a.value.length<1?alert("invalid url, cannot process"):(a=a.value,this.beginExtraction(new Readium.Models.ZipBookExtractor({url:a,src_filename:a})))},
handleFileSelect:function(a){var a=a.target.files,b=window.webkitURL.createObjectURL(a[0]);this.beginExtraction(new Readium.Models.ZipBookExtractor({url:b,src_filename:a[0].name}))},handleDirSelect:function(a){this.beginExtraction(new Readium.Models.UnpackedBookExtractor({dir_picker:a.target}))},beginExtraction:function(a){var b=this;window._extract_view=new Readium.Views.ExtractItemView({model:a});a.on("extraction_success",function(){var c=a.packageDoc.toJSON();b.collection.add(new Readium.Models.LibraryItem(c));
setTimeout(function(){chrome.tabs.create({url:"/views/viewer.html?book="+c.key})},800)});a.extract();this.resetForm();this.hide()}});
Readium.Models.AudioClipPlayer=function(){function m(){function b(){a.removeEventListener("canplay",b);if(e>a.duration)g("File is shorter than specified clipEnd time"),e=a.duration;g("Audio data loaded");j()}g("Loading file "+f);a.setAttribute("src",f);a.addEventListener("canplay",b);a.addEventListener("ended",function(){c!=null&&clearInterval(c);d!=null&&d()})}function j(){if(k==!1&&a.currentTime>h&&a.currentTime<e)i(),a.play();else{a.addEventListener("seeked",b);console.log("setting currentTime from "+
a.currentTime+"to "+h);a.currentTime=h;var b=function(){a.removeEventListener("seeked",b);i();a.play()}}}function i(){c!=null&&clearInterval(c);c=setInterval(function(){a.currentTime>=e&&(clearInterval(c),g("clip done"),d!=null&&d())},11)}function g(a){l&&console.log(a)}var f=null,h=null,e=null,k=!1,a=new Audio,d=null,l=!1,c=null;this.setNotifyClipDone=function(a){d=a};this.setConsoleTrace=function(a){l=a};this.play=function(b,c,d,i){f=b;h=c;e=d;k=i;g("playing "+f+" from "+h+" to "+e);a==null||a.getAttribute("src")!=
f?m():j()};this.isPlaying=function(){return a==null?!1:!a.paused};this.resume=function(){a!=null&&a.play()};this.pause=function(){a!=null&&a.pause()};this.setNotifyOnPause=function(b){a.addEventListener("pause",function(){b()})};this.setNotifyOnPlay=function(b){a.addEventListener("play",function(){b()})};this.getCurrentTime=function(){return a!=null?a.currentTime:0};this.getCurrentSrc=function(){return f};this.setVolume=function(b){a.volume=b<0?0:b>1?1:b}};
Readium.Models.SmilModel=function(){function f(a){k(a);a.childNodes.length>0&&$.each(a.childNodes,function(a,b){f(b)})}function k(a){a.toString=function(){for(var a="<"+this.nodeName,b=0;b<this.attributes.length;b++)a+=" "+this.attributes.item(b).nodeName+"="+this.attributes.item(b).nodeValue;a+=">";return a};if(e.hasOwnProperty(a.tagName))a.render=e[a.tagName];if(g.hasOwnProperty(a.tagName))a.notifyChildDone=g[a.tagName];l(a)}function l(a){a.tagName=="audio"&&($(a).attr("src")!=void 0&&$(a).attr("src",
m($(a).attr("src"),h)),$(a).attr("clipBegin")!=void 0?$(a).attr("clipBegin",i($(a).attr("clipBegin"))):$(a).attr("clipBegin",0),$(a).attr("clipEnd")!=void 0?$(a).attr("clipEnd",i($(a).attr("clipEnd"))):$(a).attr("clipEnd",9999999))}function m(a,c){if(a.indexOf("://")!=-1)return a;var b=c;c[c.length-1]!="/"&&(b=c.substr(0,c.lastIndexOf("/")+1));return b+a}function i(a){var c=0,b=0,d=0;arr=a.split(":");d=parseFloat(arr.pop());arr.length>0?(b=parseFloat(arr.pop()),arr.length>0&&(c=parseFloat(arr.pop()))):
a.indexOf("min")!=-1?b=parseFloat(a.substr(0,a.indexOf("min"))):a.indexOf("ms")!=-1?d=parseFloat(a.substr(0,a.indexOf("ms")))/1E3:a.indexOf("s")!=-1?d=parseFloat(a.substr(0,a.indexOf("s"))):a.indexOf("h")!=-1&&(c=parseFloat(a.substr(0,a.indexOf("h"))));return c*3600+b*60+d}NodeLogic={parRender:function(){$.each(this.childNodes,function(a,c){c.hasOwnProperty("render")&&c.render()})},seqRender:function(a){a==null?this.firstElementChild.render():a.render()},audioNotifyChildDone:function(){this.parentNode.notifyChildDone(this)},
parNotifyChildDone:function(a){a.tagName=="audio"&&this.parentNode.notifyChildDone(this)},seqNotifyChildDone:function(a){a.nextElementSibling==null?this==d?j():this.parentNode.notifyChildDone(this):this.render(a.nextElementSibling)}};var e={seq:NodeLogic.seqRender,par:NodeLogic.parRender,body:NodeLogic.seqRender},g={seq:NodeLogic.seqNotifyChildDone,par:NodeLogic.parNotifyChildDone,body:NodeLogic.seqNotifyChildDone,audio:NodeLogic.audioNotifyChildDone,text:function(){}},h=null,j=null,d=null;this.addRenderers=
function(a){e=$.extend(e,a)};this.setUrl=function(a){h=a};this.setNotifySmilDone=function(a){j=a};this.build=function(a){d=a;f(a)};this.render=function(a){a==null||a==void 0||a==d?d.render(null):(this.peekNextAudio(a).isJumpTarget=!0,a.parentNode.render(a))};this.findNodeByAttrValue=function(a,c,b){if(d==null)return null;a=$(d).find(a+"["+c+"='"+b+"']");return a.length==0?null:a[0]};this.peekNextAudio=function(a){if(a.tagName=="par")return $(a).find("audio")[0];if(a.tagName=="text")return $(a.parentNode).find("audio")[0];
for(a=a.parentNode;a.nextElementSibling==null;)if(a=a.parentNode,a==d)return null;return $(a.nextElementSibling).find("audio")[0]}};
Readium.Models.MediaOverlay=Backbone.Model.extend({audioplayer:null,smilModel:null,defaults:{is_ready:!1,is_document_done:!1,is_playing:!1,should_highlight:!0,current_text_document_url:null,current_text_element_id:null,has_started_playback:!1},initialize:function(){var a=this;this.audioplayer=new Readium.Models.AudioClipPlayer;this.audioplayer.setConsoleTrace(!0);this.url=this.get("smil_url");this.audioplayer.setNotifyOnPause(function(){a.set({is_playing:a.audioplayer.isPlaying()})});this.audioplayer.setNotifyOnPlay(function(){a.set({is_playing:a.audioplayer.isPlaying()})})},
fetch:function(a){this.set({is_ready:!1});a||(a={});a.dataType="xml";Backbone.Model.prototype.fetch.call(this,a)},parse:function(a){var b=this;this.smilModel=new Readium.Models.SmilModel;this.smilModel.setUrl(this.get("smil_url"));this.smilModel.setNotifySmilDone(function(){b.set({is_document_done:!0})});this.smilModel.addRenderers({audio:function(){var a=this;b.audioplayer.setNotifyClipDone(function(){a.notifyChildDone()});var c=!1;if(this.hasOwnProperty("isJumpTarget"))c=this.isJumpTarget,this.isJumpTarget=
!1;b.audioplayer.play($(this).attr("src"),parseFloat($(this).attr("clipBegin")),parseFloat($(this).attr("clipEnd")),c)},text:function(){var a=$(this).attr("src");b.set({current_text_document_url:b.stripFragment(a),current_text_element_id:b.getFragment(a)})}});this.smilModel.build($(a).find("body")[0]);this.set({is_ready:!0})},startPlayback:function(a){this.get("is_ready")!=!1&&(this.set({is_document_done:!1}),this.set({has_started_playback:!0}),this.smilModel.render(a))},pause:function(){this.get("is_ready")!=
!1&&this.get("has_started_playback")!=!1&&this.audioplayer.pause()},resume:function(){this.get("is_ready")!=!1&&this.get("has_started_playback")!=!1&&this.audioplayer.resume()},findNodeByTextSrc:function(a){if(this.get("is_ready")!=!1){var b=this.smilModel.findNodeByAttrValue("text","src",a);b==null&&(b=this.smilModel.findNodeByAttrValue("seq","epub:textref",a));return b}},setVolume:function(a){this.get("is_ready")!=!1&&this.audioplayer.setVolume(a)},getFragment:function(a){return a.indexOf("#")!=
-1&&a.indexOf("#")<a.length-1?a.substr(a.indexOf("#")+1):""},stripFragment:function(a){return a.indexOf("#")==-1?a:a.substr(0,a.indexOf("#"))}});
