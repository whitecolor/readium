window.Readium={Models:{},Collections:{},Views:{},Routers:{},Utils:{},Init:function(){_router=new Readium.Routers.ViewerRouter;Backbone.history.start({pushState:!0})}};$(function(){window.Readium.Init()});
Readium.FileSystemApi=function(){var f,i=83886080,j=function(a){window.webkitRequestFileSystem(window.PERSITENT,i,function(b){f=b;a&&a(h)},d)},n=function(a){window.webkitStorageInfo.requestQuota(PERSISTENT,i,function(b){i=b;a(h)},function(b){console.log("Error",b);console.log("Exectution will not continue")})},d=function(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";
break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error: "+b)},k=function(a,b){if(b[0]=="."||b[0]=="")b=b.slice(1);a.getDirectory(b[0],{create:!0},function(a){b.length&&k(a,b.slice(1))},d)},o=function(a,b,c,g,e){c.getFile(a,{create:!1},function(d){d.remove(function(){l(a,b,c,g,e)})},function(){l(a,b,c,g,e)})},l=function(a,b,c,g,e){c.getFile(a,{create:!0,exclusive:!1},
function(a){a.createWriter(function(a){var c;a.onwriteend=function(a){g(a)};a.onerror=function(a){e(a)};if(b.webkitRelativePath||b.relativePath){var d=new FileReader;d.onload=function(b){c=new WebKitBlobBuilder;c.append(b.target.result);a.write(c.getBlob())};d.readAsArrayBuffer(b)}else c=new WebKitBlobBuilder,typeof b==="string"?(c.append(b),a.write(c.getBlob("text/plain"))):(d=new Uint8Array(b),c.append(d.buffer),a.write(c.getBlob()))},e)},e)},m=function(a,b,c,d,e){if(a[0]==="."||a[0]==="")a=a.slice(1);
a.length===1?o(a[0],b,c,d,e):c.getDirectory(a[0],{create:!0},function(c){a=a.slice(1);m(a,b,c,d,e)},e)},h={writeFile:function(a,b,c,d){a=a.split("/");m(a,b,f.root,c,d)},getFileSystem:function(){return f},readEntry:function(a,b,c){a.file(function(d){var e=new FileReader;e.onloadend=function(){this.result?b(this.result,a):c&&c()};e.readAsText(d)},c||d)},readTextFile:function(a,b,c){var g=this;f.root.getFile(a,{},function(a){g.readEntry(a,b,c)},c||d)},rmdir:function(a){f.root.getDirectory(a,{},function(a){a.removeRecursively(function(){console.log("Directory removed.")},
d)},d)},getFsUri:function(a,b,c){f.root.getFile(a,{create:!0,exclusive:!1},function(a){b(a.toURL())},c||d)},mkdir:k,genericFsErrorHandler:d};return function(a){if(f)return a(h),h;webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSITENT,function(b,c){c>0?j(a):n(function(){j(a)})})}}();
Readium.Utils.setCookie=function(d,a,b){var c=new Date;c.setDate(c.getDate()+b);a=escape(a)+(b==null?"":"; expires="+c.toUTCString());document.cookie=d+"="+a};Readium.Utils.getCookie=function(d){var a,b,c,e=document.cookie.split(";");for(a=0;a<e.length;a++)if(b=e[a].substr(0,e[a].indexOf("=")),c=e[a].substr(e[a].indexOf("=")+1),b=b.replace(/^\s+|\s+$/g,""),b==d)return unescape(c)};Readium.Utils.trimString=function(d){return d.replace(/^\s+|\s+$/g,"")};
BBFileSystemSync=function(a,b,c){if(!b.file_path)throw"Cannot sync the model to the fs without a path";switch(a){case "read":Readium.FileSystemApi(function(a){a.readTextFile(b.file_path,function(a){c.success(a)},function(a){c.error(a)})});break;case "create":throw"Not yet implemented";case "update":throw"Not yet implemented";case "delete":throw"Not yet implemented";}return null};
Readium.Utils.Guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=Math.random()*16|0;return(d=="x"?b:b&3|8).toString(16)})};
Readium.Utils.LocalStorageAdaptor=function(d){var b,f=function(){localStorage.setItem(d,JSON.stringify(b))};return function(h,a,e){var c,g=localStorage.getItem(d);b=g&&JSON.parse(g)||{};switch(h){case "read":c=a.id?b[a.id]:_.values(b);break;case "create":if(!a.id)a.id=a.attributes.id=guid();b[a.id]=a;f();c=a;break;case "update":b[a.id]=a;f();c=a;break;case "delete":delete b[a.id],f(),c=a}c?e.success&&e.success(c):e.error&&e.error("Record not found")}};
Readium.Models.ManifestItem=Backbone.Model.extend({parseMetaTags:function(){if(typeof this.get("meta_width")==="undefined"){var a=(new window.DOMParser).parseFromString(this.get("content"),"text/xml").getElementsByName("viewport")[0];return a?(a=this.parseViewportTag(a),this.set({meta_width:a.width,meta_height:a.height}),{meta_width:a.width,meta_height:a.height}):null}},parseViewportTag:function(a){for(var a=a.getAttribute("content"),a=a.replace(/\s/g,""),a=a.split(","),b={},c,d=0;d<a.length;d++)c=
a[d].split("="),c.length===2&&(b[c[0]]=c[1]);b.width=parseFloat(b.width);b.height=parseFloat(b.height);return b},resolvePath:function(a){return this.collection.packageDocument.resolvePath(a)},resolveUri:function(a){return this.collection.packageDocument.resolveUri(a)},loadContent:function(){var a=this,b=this.resolvePath(this.get("href"));Readium.FileSystemApi(function(c){c.readTextFile(b,function(b){a.set({content:b})},function(){console.log("Failed to load file: "+b)})})}});
Readium.Models.SpineItem=Readium.Models.ManifestItem.extend({initialize:function(){if(this.isFixedLayout())this.on("change:content",this.parseMetaTags,this);this.loadContent()},buildSectionJSON:function(a,b){if(!a)return null;var c=Object.create(null);c.width=this.get("meta_width")||0;c.height=this.get("meta_height")||0;c.uri=this.packageDocument.resolveUri(a.get("href"));c.page_class=this.getPositionClass(a,b);return c},toJSON:function(){this.isFixedLayout()&&this.parseMetaTags();var a={};a.width=
this.get("meta_width")||0;a.height=this.get("meta_height")||0;a.uri=this.resolveUri(this.get("href"));a.page_class=this.getPositionClass();return a},getPositionClass:function(){var a=this.collection.packageDocument.get("book"),b=this.get("spine_index");return a.get("apple_fixed")?b===0?"center_page":b%2===1&&b===this.collection.length?"center_page":b%2===0?"right_page":"left_page":b%2===0?"right_page":"left_page"},isFixedLayout:function(){return typeof this.get("fixed_flow")!=="undefined"?this.get("fixed_flow"):
this.collection.isBookFixedLayout()},getPageView:function(){if(!this.view)this.view=new Readium.Views.FixedPageView({model:this});return this.view},hasMediaOverlay:function(){return!!this.get("media_overlay")&&!!this.getMediaOverlay()},getMediaOverlay:function(){return this.collection.getMediaOverlay(this.get("media_overlay"))}});Readium.Collections.ManifestItems=Backbone.Collection.extend({model:Readium.Models.ManifestItem,initialize:function(a,b){this.packageDocument=b.packageDocument}});
Readium.Collections.Spine=Backbone.Collection.extend({model:Readium.Models.SpineItem,initialize:function(a,b){this.packageDocument=b.packageDocument},isBookFixedLayout:function(){return this.packageDocument.get("book").isFixedLayout()},getMediaOverlay:function(a){return this.packageDocument.getMediaOverlayItem(a)}});
Readium.Models.PackageDocumentBase=Backbone.Model.extend({initialize:function(a,b){if(b&&b.file_path){this.file_path=b.file_path;var c=this;b.root_url?c.uri_obj=new URI(b.root_url):Readium.FileSystemApi(function(a){a.getFsUri(c.file_path,function(a){c.uri_obj=new URI(a)})})}},jath_template:{metadata:{id:"//def:metadata/dc:identifier",epub_version:"//def:package/@version",title:"//def:metadata/dc:title",author:"//def:metadata/dc:creator",publisher:"//def:metadata/dc:publisher",description:"//def:metadata/dc:description",
rights:"//def:metadata/dc:rights",language:"//def:metadata/dc:language",pubdate:"//def:metadata/dc:date",modified_date:"//def:metadata/def:meta[@property='dcterms:modified']",layout:"//def:metadata/def:meta[@property='rendition:layout']",spread:"//def:metadata/def:meta[@property='rendition:spread']",orientation:"//def:metadata/def:meta[@property='rendition:orientation']",ncx:"//def:spine/@toc",page_prog_dir:"//def:spine/@page-progression-direction"},manifest:["//def:item",{id:"@id",href:"@href",media_type:"@media-type",
properties:"@properties",media_overlay:"@media-overlay"}],spine:["//def:itemref",{idref:"@idref",properties:"@properties"}],bindings:["//def:bindings/def:mediaType",{handler:"@handler",media_type:"@media-type"}]},getCoverHref:function(a){var b,c;b=a.getElementsByTagName("manifest")[0];c=$('item[properties~="cover-image"]',b);if(c.length===1&&c.attr("href"))return c.attr("href");a=$('meta[name="cover"]',a);c=a.attr("content");if(a.length===1&&c&&(c=$('item[id="'+c+'"]',b),c.length===1&&c.attr("href")))return c.attr("href");
c=$("#cover",b);return c.length===1&&c.attr("href")?c.attr("href"):null},parseSpineProperties:function(a){for(var b=function(a){for(var b={},a=a.split(" "),c=0;c<a.length;c++){if(a[c]==="rendition:page-spread-center")b.page_spread="center";if(a[c]==="page-spread-left")b.page_spread="left";if(a[c]==="page-spread-right")b.page_spread="right";if(a[c]==="page-spread-right")b.page_spread="right";if(a[c]==="rendition:layout-reflowable")b.fixed_flow=!1;if(a[c]==="rendition:layout-pre-paginated")b.fixed_flow=
!0}return b},c=0;c<a.length;c++){var d=b(a[c].properties);_.extend(a[c],d)}return a},resolveMediaOverlays:function(a){var b=this,c={};a.forEach(function(a){if(a.get("media_type")==="application/smil+xml"){var e=b.resolveUri(a.get("href")),e=new Readium.Models.MediaOverlay({smil_url:e});e.fetch();c[a.id]=e}});return c},paginateBackwards:function(a){return $("spine",a).attr("page-progression-direction")==="ltr"},parse:function(a){var b;typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,
"text/xml"));Jath.resolver=function(a){return{def:"http://www.idpf.org/2007/opf",dc:"http://purl.org/dc/elements/1.1/"}[a]};b=Jath.parse(this.jath_template,a);b.paginate_backwards=this.paginateBackwards(a);if(a=this.getCoverHref(a))b.metadata.cover_href=this.resolveUri(a);if(b.metadata.layout==="pre-paginated")b.metadata.fixed_layout=!0;b.manifest=new Readium.Collections.ManifestItems(b.manifest,{packageDocument:this});b.mo_map=this.resolveMediaOverlays(b.manifest);b.spine=this.parseSpineProperties(b.spine);
return b},crunchSpine:function(a,b){var c=-1,d=_.map(a,function(a){c+=1;var d=b.find(function(b){if(b.get("id")===a.idref)return b});return _.extend({},a,d.attributes,{spine_index:c})});return new Readium.Collections.Spine(d,{packageDocument:this})},reset:function(a){this.set(this.parse(a))},resolveUri:function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()},resolvePath:function(a){var b=this.file_path,a=a.indexOf("../")===0?a.substr(3):a,c=b.lastIndexOf("/");return b.substr(0,c)+"/"+
a}});
Readium.Models.ValidatedPackageMetaData=Readium.Models.PackageDocumentBase.extend({initialize:function(a,b){Readium.Models.PackageDocumentBase.prototype.initialize.call(this,a,b);this.set("package_doc_path",this.file_path)},validate:function(){},defaults:{fixed_layout:!1,apple_fixed:!1,open_to_spread:!1,cover_href:"/images/library/missing-cover-image.png",created_at:new Date,updated_at:new Date,paginate_backwards:!1},parseIbooksDisplayOptions:function(a){var b=(new window.DOMParser).parseFromString(a,"text/xml"),
a=b.getElementsByName("fixed-layout")[0],b=b.getElementsByName("open-to-spread")[0];this.set({fixed_layout:a&&a.textContent.toLowerCase().trim()==="true",open_to_spread:b&&b.textContent.toLowerCase().trim()==="true",apple_fixed:a&&a.textContent.toLowerCase().trim()==="true"})},parse:function(a){return Readium.Models.PackageDocumentBase.prototype.parse.call(this,a).metadata},save:function(a,b){var c=this;this.set("updated_at",new Date);Lawnchair(function(){this.save(c.toJSON(),b.success)})}});
Readium.Models.PackageDocument=Readium.Models.PackageDocumentBase.extend({initialize:function(a,b){Readium.Models.PackageDocumentBase.prototype.initialize.call(this,a,b);this.on("change:spine_position",this.onSpinePosChanged)},onSpinePosChanged:function(){this.get("spine_position")>=this.previous("spine_position")?this.trigger("increased:spine_position"):this.trigger("decreased:spine_position")},validate:function(a){if(!a.manifest&&!this.get("manifest"))return"ERROR: All ePUBs must have a manifest";
var b=a.spine||this.get("spine");if(!b)return"ERROR: All ePUBs must have a spine";if(a.spine_position<0||a.spine_position>=b.length)return"ERROR: invalid spine position"},sync:BBFileSystemSync,defaults:{spine_position:0},getManifestItemById:function(a){return this.get("manifest").find(function(b){if(b.get("id")===a)return b})},getSpineItem:function(a){return this.get("res_spine").at(a)},spineLength:function(){return this.get("res_spine").length},goToNextSection:function(){this.set({spine_position:this.get("spine_position")+
1})},goToPrevSection:function(){this.set({spine_position:this.get("spine_position")-1})},spineIndexFromHref:function(a){for(var b=this.get("res_spine"),a=this.resolveUri(a).replace(/#.*$/,""),c=0;c<b.length;c++){var d=b.at(c).get("href"),d=this.resolveUri(d).replace(/#.*$/,"");if(d===a)return c}return-1},goToHref:function(a){var b=this.get("spine"),c=this.get("manifest"),d=this,a=d.resolveUri(a).replace(/#.*$/,""),c=c.find(function(b){var c=d.resolveUri(b.get("href")).replace(/#.*$/,"");if(a==c)return b});
if(!c)return null;for(var c=c.get("id"),e=0;e<b.length;++e)if(b[e].idref===c){this.set({spine_position:e},{silent:!0});this._previousAttributes.spine_position=0;this.trigger("change:spine_position");break}},getTocItem:function(){var a=this.get("manifest"),b=this.get("metadata").ncx,c=a.find(function(a){return a.get("properties")==="nav"});return c?c:b&&b.length>0?a.find(function(a){return a.get("id")===b}):null},getMediaOverlayItem:function(a){var b=this.get("mo_map");return b&&b[a]},parse:function(a){a=
Readium.Models.PackageDocumentBase.prototype.parse.call(this,a);a.res_spine=this.crunchSpine(a.spine,a.manifest);return a}});
Readium.Models.Ebook=Backbone.Model.extend({initialize:function(){var a=this;this.paginator=new Readium.Models.Paginator({book:this});this.packageDocument=new Readium.Models.PackageDocument({book:a},{file_path:this.get("package_doc_path")});this.packageDocument.fetch({success:function(){var b=a.restorePosition();a.set("spine_position",b);b=a.paginator.renderSpineItems(!1);a.set("rendered_spine_items",b);a.set("has_toc",!!a.packageDocument.getTocItem())}});this.on("change:num_pages",this.adjustCurrentPage,
this);this.on("change:spine_position",this.savePosition,this);this.on("change:spine_position",this.setMetaSize,this)},save:function(a,b){var c={success:function(){}};_.extend(c,b);var d=this;this.set("updated_at",new Date);Lawnchair(function(){this.save(d.toJSON(),c.success)})},defaults:{font_size:10,current_page:[1],num_pages:0,two_up:!1,full_screen:!1,toolbar_visible:!0,toc_visible:!1,can_two_up:!0,rendered_spine_items:[],current_theme:"default-theme",current_margin:3},toJSON:function(){return{apple_fixed:this.get("apple_fixed"),
author:this.get("author"),cover_href:this.get("cover_href"),created_at:this.get("created_at"),current_theme:this.get("current_theme"),description:this.get("description"),epub_version:this.get("epub_version"),fixed_layout:this.get("fixed_layout"),id:this.get("id"),key:this.get("key"),language:this.get("language"),layout:this.get("layout"),modified_date:this.get("modified_date"),ncx:this.get("ncx"),open_to_spread:this.get("open_to_spread"),orientation:this.get("orientation"),package_doc_path:this.get("package_doc_path"),
page_prog_dir:this.get("page_prog_dir"),paginate_backwards:this.get("paginate_backwards"),pubdate:this.get("pubdate"),publisher:this.get("publisher"),rights:this.get("rights"),spread:this.get("spread"),src_url:this.get("src_url"),title:this.get("title"),updated_at:this.get("updated_at"),current_theme:this.get("current_theme"),current_margin:this.get("current_margin"),font_size:this.get("font_size"),two_up:this.get("two_up")}},toggleTwoUp:function(){if(this.get("can_two_up")){debugger;var a=this.get("two_up"),
b=this.get("current_page"),c=[];a?c[0]=b[0]===0?1:b[0]:this.getCurrentSection().isFixedLayout()?b[0]%2===0?(c[0]=b[0],c[1]=b[0]+1):(c[0]=b[0]-1,c[1]=b[0]):b[0]%2===1?(c[0]=b[0],c[1]=b[0]+1):(c[0]=b[0]-1,c[1]=b[0]);this.set({two_up:!a,current_page:c})}},toggleFullScreen:function(){this.set({full_screen:!this.get("full_screen")})},increaseFont:function(){this.set({font_size:this.get("font_size")+1})},decreaseFont:function(){this.set({font_size:this.get("font_size")-1})},toggleToc:function(){this.set("toc_visible",
!this.get("toc_visible"))},goRight:function(){this.get("page_prog_dir")==="rtl"?this.prevPage():this.nextPage()},goLeft:function(){this.get("page_prog_dir")==="rtl"?this.nextPage():this.prevPage()},prevPage:function(){var a=this.get("current_page"),b=a[0]-1;a[0]<=1?this.goToPrevSection():this.get("two_up")?(this.set("current_page",[b-1,b]),this.get("rendered_spine_items").length>1&&(a=this.get("rendered_spine_items")[b>1?b-2:0],this.set("spine_position",a))):(this.set("current_page",[b]),this.get("rendered_spine_items").length>
1&&(a=this.get("rendered_spine_items")[b-1],this.set("spine_position",a)))},nextPage:function(){var a=this.get("current_page"),b=a[a.length-1]+1;a[a.length-1]>=this.get("num_pages")?this.goToNextSection():(this.get("two_up")?this.set("current_page",[b,b+1]):this.set("current_page",[b]),this.get("rendered_spine_items").length>1&&(a=this.get("rendered_spine_items")[b-1],this.set("spine_position",a)))},goToLastPage:function(){this.goToPage(this.get("num_pages"))},goToPage:function(a){this.get("two_up")?
this.getCurrentSection().isFixedLayout()?a%2===0?this.set("current_page",[a,a+1]):this.set("current_page",[a-1,a]):a%2===1?this.set("current_page",[a,a+1]):this.set("current_page",[a-1,a]):this.set("current_page",[a])},restorePosition:function(){var a=Readium.Utils.getCookie(this.get("key"));return parseInt(a,10)||0},savePosition:function(){Readium.Utils.setCookie(this.get("key"),this.get("spine_position"),365)},resolvePath:function(a){return this.packageDocument.resolvePath(a)},adjustCurrentPage:function(){var a=
this.get("current_page"),b=this.get("num_pages");this.get("two_up");a[a.length-1]>b&&this.goToLastPage()},goToNextSection:function(){this.hasNextSection()&&this.setSpinePos(this.get("spine_position")+1)},goToPrevSection:function(){this.hasPrevSection()&&this.setSpinePosBackwards(this.get("spine_position")-1)},hasNextSection:function(){return this.get("spine_position")<this.packageDocument.spineLength()-1},hasPrevSection:function(){return this.get("spine_position")>0},setSpinePos:function(a){if(!(a<
0||a>=this.packageDocument.spineLength())){var b=this.get("rendered_spine_items");this.set("spine_position",a);b.indexOf(a)>=0?b.length>1&&this.goToPage(b.indexOf(a)+1):this.set("rendered_spine_items",this.paginator.renderSpineItems(!1))}},setSpinePosBackwards:function(a){a<0||a>=this.packageDocument.spineLength()||(this.set("spine_position",a),this.get("rendered_spine_items").indexOf(a)>=0||this.set("rendered_spine_items",this.paginator.renderSpineItems(!0)))},goToHref:function(a){a=a.match(/([^#]*)(?:#(.*))?/);
a[1]&&this.setSpinePos(this.packageDocument.spineIndexFromHref(a[1]));a[2]&&this.set({hash_fragment:a[2]})},changPageNumber:function(a){var b=this.get("current_page"),c=[],d=a-b[b.length-1];d>0&&(d=0);for(var e=0;e<b.length;e++)c[e]=b[e]+d;this.set({num_pages:a,current_page:c})},getToc:function(){var a=this.packageDocument.getTocItem();return a?Readium.Models.Toc.getToc(a,{file_path:this.resolvePath(a.get("href")),book:this}):null},setMetaSize:function(){this.meta_section&&this.meta_section.off("change:meta_height",
this.setMetaSize);this.meta_section=this.getCurrentSection();this.meta_section.get("meta_height")&&this.set("meta_size",{width:this.meta_section.get("meta_width"),height:this.meta_section.get("meta_height")});this.meta_section.on("change:meta_height",this.setMetaSize,this)},spinePositionChangedHandler:function(){var a=this,b=this.getCurrentSection().get("href"),c=this.packageDocument.resolveUri(b),b=this.resolvePath(b);this.set("current_section_url",c);Readium.FileSystemApi(function(c){c.readTextFile(b,
function(b){a.set({current_content:b})},function(){console.log("Failed to load file: "+b)})});this.savePosition()},getCurrentSection:function(a){a||(a=0);return this.packageDocument.getSpineItem(this.get("spine_position")+a)},playMo:function(a){var b=this.getCurrentSection().getMediaOverlay();if(b){this.set("mo_playing",b);var c=this;b.on("change:current_text_document_url",function(){c.goToHref(b.get("current_text_document_url"))});b.on("change:current_text_element_id",function(){var a=b.get("current_text_element_id");
c.set("hash_fragment",a);c.set("current_mo_frag",a)});b.on("change:is_document_done",function(){c.pauseMo();c.hasNextSection()&&(c.goToNextSection(),c.playMo(!0))});b.get("has_started_playback")&&a==!1?b.resume():b.startPlayback(null)}else alert("Sorry, the current EPUB does not contain a media overlay for this content")},pauseMo:function(){var a=this.get("mo_playing");a&&(a.off(),a.pause(),this.set("mo_playing",null))},isFixedLayout:function(){return this.get("fixed_layout")||this.get("apple_fixed")}});
Readium.Models.OptionsPresenter=Backbone.Model.extend({initialize:function(){var a=this.get("book");if(!a)throw"ebook must be set in the constructor";this.resetOptions();a.on("change:font_size",this.resetOptions,this);a.on("change:two_up",this.resetOptions,this);a.on("change:current_theme",this.resetOptions,this);a.on("change:current_margin",this.resetOptions,this)},applyOptions:function(){var a=this.get("book"),b=this.get("two_up")!==a.get("two_up");a.set({font_size:this.get("font_size"),current_theme:this.get("current_theme"),
current_margin:this.get("current_margin")});b&&a.toggleTwoUp();a.save()},resetOptions:function(){var a=this.get("book");this.set({font_size:a.get("font_size"),two_up:a.get("two_up"),current_theme:a.get("current_theme"),current_margin:a.get("current_margin")})}});
Readium.Models.Toc=Backbone.Model.extend({sync:BBFileSystemSync,initialize:function(a){this.file_path=a.file_path;this.book=a.book;this.book.on("change:toc_visible",this.setVisibility,this);this.book.on("change:toolbar_visible",this.setTocVis,this)},handleLink:function(a){this.book.goToHref(a)},setVisibility:function(){this.set("visible",this.book.get("toc_visible"))},hide:function(){this.book.set("toc_visible",!1)},setTocVis:function(){this.book.get("toolbar_visible")||this.book.set("toc_visible",
!1)},defaults:{visible:!1}},{XHTML_MIME:"application/xhtml+xml",XML_MIME:"text/xml",NCX_MIME:"application/x-dtbncx+xml",getToc:function(a,b){var c=a.get("media_type");if(c===Readium.Models.Toc.XHTML_MIME||c===Readium.Models.Toc.XML_MIME)return new Readium.Models.XhtmlToc(b);else if(c===Readium.Models.Toc.NCX_MIME)return new Readium.Models.NcxToc(b)}});
Readium.Models.NcxToc=Readium.Models.Toc.extend({jath_template:{title:"//ncx:docTitle/ncx:text",navs:["//ncx:navMap/ncx:navPoint",{text:"ncx:navLabel/ncx:text",href:"ncx:content/@src"}]},parse:function(a){typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));Jath.resolver=function(a){return a==="ncx"?"http://www.daisy.org/z3986/2005/ncx/":""};return Jath.parse(this.jath_template,a)},TocView:function(){return new Readium.Views.NcxTocView({model:this})}});
Readium.Models.XhtmlToc=Readium.Models.Toc.extend({parse:function(a){var b={};typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));b.title=$("title",a).text();b.body=$("body",a);return b},TocView:function(){return new Readium.Views.XhtmlTocView({model:this})}});
Readium.Models.SmilModel=function(){function f(a){k(a);a.childNodes.length>0&&$.each(a.childNodes,function(a,b){f(b)})}function k(a){a.toString=function(){for(var a="<"+this.nodeName,b=0;b<this.attributes.length;b++)a+=" "+this.attributes.item(b).nodeName+"="+this.attributes.item(b).nodeValue;a+=">";return a};if(e.hasOwnProperty(a.tagName))a.render=e[a.tagName];if(g.hasOwnProperty(a.tagName))a.notifyChildDone=g[a.tagName];l(a)}function l(a){a.tagName=="audio"&&($(a).attr("src")!=void 0&&$(a).attr("src",
m($(a).attr("src"),h)),$(a).attr("clipBegin")!=void 0?$(a).attr("clipBegin",i($(a).attr("clipBegin"))):$(a).attr("clipBegin",0),$(a).attr("clipEnd")!=void 0?$(a).attr("clipEnd",i($(a).attr("clipEnd"))):$(a).attr("clipEnd",9999999))}function m(a,c){if(a.indexOf("://")!=-1)return a;var b=c;c[c.length-1]!="/"&&(b=c.substr(0,c.lastIndexOf("/")+1));return b+a}function i(a){var c=0,b=0,d=0;arr=a.split(":");d=parseFloat(arr.pop());arr.length>0?(b=parseFloat(arr.pop()),arr.length>0&&(c=parseFloat(arr.pop()))):
a.indexOf("min")!=-1?b=parseFloat(a.substr(0,a.indexOf("min"))):a.indexOf("ms")!=-1?d=parseFloat(a.substr(0,a.indexOf("ms")))/1E3:a.indexOf("s")!=-1?d=parseFloat(a.substr(0,a.indexOf("s"))):a.indexOf("h")!=-1&&(c=parseFloat(a.substr(0,a.indexOf("h"))));return c*3600+b*60+d}NodeLogic={parRender:function(){$.each(this.childNodes,function(a,c){c.hasOwnProperty("render")&&c.render()})},seqRender:function(a){a==null?this.firstElementChild.render():a.render()},audioNotifyChildDone:function(){this.parentNode.notifyChildDone(this)},
parNotifyChildDone:function(a){a.tagName=="audio"&&this.parentNode.notifyChildDone(this)},seqNotifyChildDone:function(a){a.nextElementSibling==null?this==d?j():this.parentNode.notifyChildDone(this):this.render(a.nextElementSibling)}};var e={seq:NodeLogic.seqRender,par:NodeLogic.parRender,body:NodeLogic.seqRender},g={seq:NodeLogic.seqNotifyChildDone,par:NodeLogic.parNotifyChildDone,body:NodeLogic.seqNotifyChildDone,audio:NodeLogic.audioNotifyChildDone,text:function(){}},h=null,j=null,d=null;this.addRenderers=
function(a){e=$.extend(e,a)};this.setUrl=function(a){h=a};this.setNotifySmilDone=function(a){j=a};this.build=function(a){d=a;f(a)};this.render=function(a){a==null||a==void 0||a==d?d.render(null):(this.peekNextAudio(a).isJumpTarget=!0,a.parentNode.render(a))};this.findNodeByAttrValue=function(a,c,b){if(d==null)return null;a=$(d).find(a+"["+c+"='"+b+"']");return a.length==0?null:a[0]};this.peekNextAudio=function(a){if(a.tagName=="par")return $(a).find("audio")[0];if(a.tagName=="text")return $(a.parentNode).find("audio")[0];
for(a=a.parentNode;a.nextElementSibling==null;)if(a=a.parentNode,a==d)return null;return $(a.nextElementSibling).find("audio")[0]}};
Readium.Models.MediaOverlay=Backbone.Model.extend({audioplayer:null,smilModel:null,defaults:{is_ready:!1,is_document_done:!1,is_playing:!1,should_highlight:!0,current_text_document_url:null,current_text_element_id:null,has_started_playback:!1},initialize:function(){var a=this;this.audioplayer=new Readium.Models.AudioClipPlayer;this.audioplayer.setConsoleTrace(!0);this.url=this.get("smil_url");this.audioplayer.setNotifyOnPause(function(){a.set({is_playing:a.audioplayer.isPlaying()})});this.audioplayer.setNotifyOnPlay(function(){a.set({is_playing:a.audioplayer.isPlaying()})})},
fetch:function(a){this.set({is_ready:!1});a||(a={});a.dataType="xml";Backbone.Model.prototype.fetch.call(this,a)},parse:function(a){var b=this;this.smilModel=new Readium.Models.SmilModel;this.smilModel.setUrl(this.get("smil_url"));this.smilModel.setNotifySmilDone(function(){b.set({is_document_done:!0})});this.smilModel.addRenderers({audio:function(){var a=this;b.audioplayer.setNotifyClipDone(function(){a.notifyChildDone()});var c=!1;if(this.hasOwnProperty("isJumpTarget"))c=this.isJumpTarget,this.isJumpTarget=
!1;b.audioplayer.play($(this).attr("src"),parseFloat($(this).attr("clipBegin")),parseFloat($(this).attr("clipEnd")),c)},text:function(){var a=$(this).attr("src");b.set({current_text_document_url:b.stripFragment(a),current_text_element_id:b.getFragment(a)})}});this.smilModel.build($(a).find("body")[0]);this.set({is_ready:!0})},startPlayback:function(a){this.get("is_ready")!=!1&&(this.set({is_document_done:!1}),this.set({has_started_playback:!0}),this.smilModel.render(a))},pause:function(){this.get("is_ready")!=
!1&&this.get("has_started_playback")!=!1&&this.audioplayer.pause()},resume:function(){this.get("is_ready")!=!1&&this.get("has_started_playback")!=!1&&this.audioplayer.resume()},findNodeByTextSrc:function(a){if(this.get("is_ready")!=!1){var b=this.smilModel.findNodeByAttrValue("text","src",a);b==null&&(b=this.smilModel.findNodeByAttrValue("seq","epub:textref",a));return b}},setVolume:function(a){this.get("is_ready")!=!1&&this.audioplayer.setVolume(a)},getFragment:function(a){return a.indexOf("#")!=
-1&&a.indexOf("#")<a.length-1?a.substr(a.indexOf("#")+1):""},stripFragment:function(a){return a.indexOf("#")==-1?a:a.substr(0,a.indexOf("#"))}});
Readium.Models.AudioClipPlayer=function(){function m(){function b(){a.removeEventListener("canplay",b);if(e>a.duration)g("File is shorter than specified clipEnd time"),e=a.duration;g("Audio data loaded");j()}g("Loading file "+f);a.setAttribute("src",f);a.addEventListener("canplay",b);a.addEventListener("ended",function(){c!=null&&clearInterval(c);d!=null&&d()})}function j(){if(k==!1&&a.currentTime>h&&a.currentTime<e)i(),a.play();else{a.addEventListener("seeked",b);console.log("setting currentTime from "+
a.currentTime+"to "+h);a.currentTime=h;var b=function(){a.removeEventListener("seeked",b);i();a.play()}}}function i(){c!=null&&clearInterval(c);c=setInterval(function(){a.currentTime>=e&&(clearInterval(c),g("clip done"),d!=null&&d())},11)}function g(a){l&&console.log(a)}var f=null,h=null,e=null,k=!1,a=new Audio,d=null,l=!1,c=null;this.setNotifyClipDone=function(a){d=a};this.setConsoleTrace=function(a){l=a};this.play=function(b,c,d,i){f=b;h=c;e=d;k=i;g("playing "+f+" from "+h+" to "+e);a==null||a.getAttribute("src")!=
f?m():j()};this.isPlaying=function(){return a==null?!1:!a.paused};this.resume=function(){a!=null&&a.play()};this.pause=function(){a!=null&&a.pause()};this.setNotifyOnPause=function(b){a.addEventListener("pause",function(){b()})};this.setNotifyOnPlay=function(b){a.addEventListener("play",function(){b()})};this.getCurrentTime=function(){return a!=null?a.currentTime:0};this.getCurrentSrc=function(){return f};this.setVolume=function(b){a.volume=b<0?0:b>1?1:b}};
Readium.Models.Paginator=Backbone.Model.extend({renderToLastPage:!1,initialize:function(){this.rendered_spine_positions=[];this.model=this.get("book")},renderSpineItems:function(a){var b=this.model,c=b.get("spine_position"),e=this;this.rendered_spine_positions=[];this.v&&this.v.destruct();if(this.shouldRenderAsFixed(b.getCurrentSection())){this.should_two_up=b.get("two_up");b.set("two_up",!1);this.v=new Readium.Views.FixedPaginationView({model:b});this.v.render();for(var a=1,d=this.findPrerenderStart();this.shouldPreRender(this.model.getCurrentSection(d));)this.v.addPage(b.getCurrentSection(d),
a),this.rendered_spine_positions.push(c+d),a+=1,d+=1;c=this.rendered_spine_positions.indexOf(c)+1;b.set("num_pages",a-1);b.goToPage(c);setTimeout(function(){e.v.setContainerSize()},5)}else this.shouldScroll()?this.v=new Readium.Views.ScrollingPaginationView({model:b}):(this.should_two_up&&b.set("two_up",!0),this.v=new Readium.Views.ReflowablePaginationView({model:b})),this.v.render(!!a),this.rendered_spine_positions.push(c);return this.rendered_spine_positions},findPrerenderStart:function(){for(var a=
0;this.shouldPreRender(this.model.getCurrentSection(a));)a-=1;return a+1},shouldRenderAsFixed:function(a){return a.isFixedLayout()},shouldPreRender:function(a){return a&&this.shouldRenderAsFixed(a)},shouldScroll:function(){var a=localStorage.READIUM_OPTIONS;return!(a&&JSON.parse(a)||{singleton:{}}).singleton.paginate_everything}});
Readium.Models.Trigger=function(a){a=$(a);this.action=a.attr("action");this.ref=a.attr("ref");this.event=a.attr("ev:event");this.observer=a.attr("ev:observer");this.ref=a.attr("ref")};Readium.Models.Trigger.prototype.subscribe=function(a){var b=this;$("#"+this.observer,a).on(this.event,function(){b.execute(a)})};
Readium.Models.Trigger.prototype.execute=function(a){a=$("#"+this.ref,a);switch(this.action){case "show":a.css("visibility","visible");break;case "hide":a.css("visibility","hidden");break;case "play":a[0].currentTime=0;a[0].play();break;case "pause":a[0].pause();break;case "resume":a[0].play();break;case "mute":a[0].muted=!0;break;case "unmute":a[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}};
Readium.Views.PaginationViewBase=Backbone.View.extend({el:"#readium-book-view-el",initialize:function(){this.model.on("change:current_page",this.changePage,this);this.model.on("change:font_size",this.setFontSize,this);this.model.on("change:hash_fragment",this.goToHashFragment,this);this.bindingTemplate=_.template($("#binding-template").html())},destruct:function(){console.log("Pagination base destructor called");this.model.off("change:current_page",this.changePage);this.model.off("change:font_size",
this.setFontSize);this.model.off("change:hash_fragment",this.goToHashFragment);this.resetEl()},linkClickHandler:function(a){a.preventDefault();a=a.srcElement.attributes.href.value;a.match(/^http(s)?:/)?chrome.tabs.create({url:a}):this.model.goToHref(a)},goToHashFragment:function(){},getBindings:function(){var a=this.model.packageDocument;return a.get("bindings").map(function(b){b.selector='object[type="'+b.media_type+'"]';b.url=a.getManifestItemById(b.handler).get("href");b.url=a.resolveUri(b.url);
return b})},applyBindings:function(a){for(var b=this,c=this.getBindings(),d=0,d=0;d<c.length;d++)$(c[d].selector,a).each(function(){var a=[],e=$(this),f=e.attr("data");a.push("src="+b.model.packageDocument.resolveUri(f));a.push("type="+c[d].media_type);a=c[d].url+"?"+a.join("&");f=$(b.bindingTemplate({}));f.attr("src",a);e.html(f)})},applyTriggers:function(a,b){for(var c=0;c<b.length;c++)b[c].subscribe(a)},parseTriggers:function(a){var b=[];$("trigger",a).each(function(){b.push(new Readium.Models.Trigger(this))});
return b},applySwitches:function(a){$("switch",a).each(function(){var a=!1;$("case",this).each(function(){var c;if(c=!a)(c=this.attributes["required-namespace"])?c=_.include(["http://www.w3.org/1998/Math/MathML"],c):(console.log("Encountered a case statement with no required-namespace"),c=!1);c?a=!0:$(this).remove()});a&&$("default",this).remove()})},addStyleSheets:function(a){var b,c,d=!0;b=$(".readium-dynamic-sh");c=$("link[rel*='stylesheet']",a);b.length===c.length?b.each(function(a){var e=$(b[a]).attr("href"),
a=$(c[a]).attr("href");e!==a&&(d=!1)}):d=!1;d||($(".readium-dynamic-sh").remove(),$(c.get().reverse()).each(function(){var a=$(this);a.addClass("readium-dynamic-sh");$("head").prepend(a)}))},addSwipeHandlers:function(a){var b=this;$(a).on("swipeleft",function(a){a.preventDefault();b.model.goRight()});$(a).on("swiperight",function(a){a.preventDefault();b.model.goLeft()})},setUpMode:function(){var a=this.model.get("two_up");this.$el.toggleClass("two-up",a);this.$("#spine-divider").toggle(a)},events:{"click #page-margin":function(){this.trigger("toggle_ui")},
"click #readium-content-container a":function(a){this.linkClickHandler(a)}},isPageVisible:function(a,b){return b.indexOf(a)!==-1},changePage:function(){var a=this,b=this.model.get("current_page"),c=this.model.get("two_up");this.$(".page-wrap").each(function(d){c||(d+=1);$(this).toggleClass("hidden-page",!a.isPageVisible(d,b))})},replaceContent:function(a){this.$("#readium-content-container").css("visibility","hidden").html(a).append("<div id='content-end'></div>")},toggleTwoUp:function(){},setFontSize:function(){var a=
this.model.get("font_size")/10;$("#readium-content-container").css("font-size",a+"em");this.renderPages()},injectMathJax:function(a){var a=a.contentDocument,b=a.createElement("script");b.type="text/javascript";b.src=MathJax.Hub.config.root+"/MathJax.js?config=readium-iframe";a.getElementsByTagName("head")[0].appendChild(b)},injectLinkHandler:function(a){var b=this;$("a",a.contentDocument).click(function(a){b.linkClickHandler(a)})},resetEl:function(){$("body").removeClass("apple-fixed-layout");$("#readium-book-view-el").attr("style",
"");this.$el.toggleClass("two-up",!1);this.$("#spine-divider").toggle(!1);this.replaceContent("");$("#page-wrap").css({position:"relative",right:"0px",top:"0px","-webkit-transform":"scale(1.0) translate(0px, 0px)"})},iframeLoadCallback:function(a){this.applyBindings($(a.srcElement).contents());this.applySwitches($(a.srcElement).contents());this.addSwipeHandlers($(a.srcElement).contents());this.injectMathJax(a.srcElement);this.injectLinkHandler(a.srcElement);var b=this.parseTriggers(a.srcElement.contentDocument);
this.applyTriggers(a.srcElement.contentDocument,b)}});
Readium.Views.FixedPaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(){this.page_template=_.template($("#fixed-page-template").html());this.empty_template=_.template($("#empty-fixed-page-template").html());Readium.Views.PaginationViewBase.prototype.initialize.call(this);this.model.on("change:two_up",this.setUpMode,this);this.model.on("change:meta_size",this.setContainerSize,this)},destruct:function(){console.log("Fixed paginator destructor called");Readium.Views.PaginationViewBase.prototype.destruct.call(this);
this.model.off("change:two_up",this.setUpMode);this.model.off("change:meta_size",this.setUpMode)},render:function(){$("body").addClass("apple-fixed-layout");this.$("#container").html("");this.setContainerSize();return this.renderPages()},setContainerSize:function(){var a=this.model.get("meta_size");if(a&&(this.$el.width(a.width*2),this.$el.height(a.height),!this.zoomed))this.zoomed=!0,setTimeout(function(){$("#page-wrap").zoomAndScale()},1)},addPage:function(a,c){var b=a.getPageView();b.on("iframe_loaded",
function(){this.iframeLoadCallback({srcElement:b.iframe()})},this);var d=a.getPageView().render().el;$(d).attr("id","page-"+c.toString());this.$("#container").append(d);this.changePage();return this},renderPages:function(){this.changePage();return this},changePage:function(){var a=this,c=this.model.get("current_page");this.model.get("two_up");this.$(".fixed-page-wrap").each(function(b){$(this).toggle(a.isPageVisible(b+1,c))})}});
Readium.Views.FixedPageView=Backbone.View.extend({className:"fixed-page-wrap",initialize:function(){this.template=_.template($("#fixed-page-template").html());this.model.on("change",this.render,this)},destruct:function(){this.model.off("change",this.render)},render:function(){var a=this;this.$el.html(this.template(this.model.toJSON()));this.$el.addClass(this.model.getPositionClass());this.$(".content-sandbox").on("load",function(){a.trigger("iframe_loaded")});return this},iframe:function(){return this.$(".content-sandbox")[0]}});
Readium.Views.ReflowablePaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(){Readium.Views.PaginationViewBase.prototype.initialize.call(this);this.page_template=_.template($("#reflowing-template").html());this.stashModernizrPrefixedProps();this.offset_dir=this.model.get("page_prog_dir")==="rtl"?"right":"left";this.model.on("change:current_page",this.pageChangeHandler,this);this.model.on("change:toc_visible",this.windowSizeChangeHandler,this);this.model.on("repagination_event",
this.windowSizeChangeHandler,this);this.model.on("change:current_theme",this.injectTheme,this);this.model.on("change:two_up",this.setUpMode,this);this.model.on("change:two_up",this.adjustIframeColumns,this);this.model.on("change:current_margin",this.marginCallback,this);this.model.on("change:mo_playing",this.renderMoPlaying,this);this.model.on("change:current_mo_frag",this.renderMoFragHighlight,this)},stashModernizrPrefixedProps:function(){var a=function(a){return a.replace(/([A-Z])/g,function(a,
b){return"-"+b.toLowerCase()}).replace(/^ms-/,"-ms-")};this.columAxis=Modernizr.prefixed("columnAxis")||"columnAxis";this.columGap=Modernizr.prefixed("columnGap")||"columnGap";this.columWidth=Modernizr.prefixed("columnWidth")||"columnWidth";this.cssColumAxis=a(this.columAxis);this.cssColumGap=a(this.columGap);this.cssColumWidth=a(this.columWidth)},destruct:function(){this.model.off("change:current_page",this.pageChangeHandler);this.model.off("change:toc_visible",this.windowSizeChangeHandler);this.model.off("repagination_event",
this.windowSizeChangeHandler);this.model.off("change:current_theme",this.windowSizeChangeHandler);this.model.off("change:two_up",this.setUpMode);this.model.off("change:two_up",this.adjustIframeColumns);this.model.off("change:current_margin",this.marginCallback);this.model.off("change:mo_playing",this.renderMoPlaying);this.model.off("change:current_mo_frag",this.renderMoFragHighlight);Readium.Views.PaginationViewBase.prototype.destruct.call(this)},render:function(a){var b=this,c=this.model.getCurrentSection().toJSON();
this.setUpMode();this.$("#container").html(this.page_template(c));this.$("#readium-flowing-content").on("load",function(c){b.adjustIframeColumns();b.iframeLoadCallback(c);b.setFontSize();b.injectTheme();b.setNumPages();a?b.model.goToLastPage():b.model.goToPage(1)});return this},getBodyColumnCss:function(){var a={};a[this.cssColumAxis]="horizontal";a[this.cssColumGap]=this.gap_width.toString()+"px";a[this.cssColumWidth]=this.page_width.toString()+"px";a.padding="0px";a.margin="0px";a.position="absolute";
a.width=this.page_width.toString()+"px";a.height=this.frame_height.toString()+"px";return a},adjustIframeColumns:function(){var a=this.$("#readium-flowing-content");this.setFrameSize();this.frame_width=parseInt(a.width(),10);this.frame_height=parseInt(a.height(),10);this.gap_width=Math.floor(this.frame_width/7);this.page_width=this.model.get("two_up")?Math.floor((this.frame_width-this.gap_width)/2):this.frame_width;$(this.getBody()).css(this.getBodyColumnCss());this.setNumPages();this.goToPage(this.model.get("current_page")[0]||
1)},getBody:function(){return this.$("#readium-flowing-content").contents()[0].documentElement},hideContent:function(){$("#flowing-wrapper").css("opacity","0")},showContent:function(){$("#flowing-wrapper").css("opacity","1")},calcPageOffset:function(a){return(a-1)*(this.page_width+this.gap_width)},setFrameSize:function(){var a=this.getFrameWidth().toString()+"px",b=this.getFrameHeight().toString()+"px";this.$("#readium-flowing-content").attr("width",a);this.$("#readium-flowing-content").attr("height",
b);this.$("#readium-flowing-content").css("width",a);this.$("#readium-flowing-content").css("height",b)},getFrameWidth:function(){var a,b=this.model.get("current_margin");b===1?this.model.get("two_up")?a=0.95:a=0.9:b===2?this.model.get("two_up")?a=0.89:a=0.8:b===3?this.model.get("two_up")?a=0.83:a=0.7:b===4?this.model.get("two_up")?a=0.77:a=0.6:this.model.get("two_up")?a=0.7:a=0.5;return Math.floor($("#flowing-wrapper").width()*a)},getFrameHeight:function(){return $("#flowing-wrapper").height()},
calcNumPages:function(){var a,b,c;a=this.getBody();b=a.style[this.offset_dir];a.style[this.offset_dir]="0px";c=this.getBody().scrollWidth;a.style[this.offset_dir]=b;a=Math.floor((c+this.gap_width)/(this.gap_width+this.page_width));a%2===0&&this.model.get("two_up");return a},pageChangeHandler:function(){var a=this;this.hideContent();setTimeout(function(){a.goToPage(a.model.get("current_page")[0])},150)},goToPage:function(a){a=this.calcPageOffset(a).toString()+"px";$(this.getBody()).css(this.offset_dir,
"-"+a);this.showContent()},goToHashFragment:function(){var a=this.model.get("hash_fragment");if(a&&(a=$("#"+a,this.getBody())[0])){for(;a.children.length>0;)a=a.children[0];a=this.getElemPageNumber(a);a>0&&this.model.goToPage(a)}},getElemPageNumber:function(a){a=a.getClientRects();if(!a||a.length<1)return-1;a=a[0][this.offset_dir];a-=parseInt(this.getBody().style[this.offset_dir],10);return Math.ceil(a/(this.page_width+this.gap_width))},windowSizeChangeHandler:function(){this.adjustIframeColumns()},
setFontSize:function(){var a=this.model.get("font_size")/10;$(this.getBody()).css("font-size",a+"em");this.setNumPages()},marginCallback:function(){this.adjustIframeColumns()},themes:{"default-theme":{"background-color":"white",color:"black","mo-color":"#777"},"vancouver-theme":{"background-color":"#DDD",color:"#576b96","mo-color":"#777"},"ballard-theme":{"background-color":"#576b96",color:"#DDD","mo-color":"#888"},"parchment-theme":{"background-color":"#f7f1cf",color:"#774c27","mo-color":"#eebb22"},
"night-theme":{"background-color":"black",color:"white","mo-color":"#666"}},injectTheme:function(){var a=this.model.get("current_theme");a==="default"&&(a="default-theme");$(this.getBody()).css({color:this.themes[a].color,"background-color":this.themes[a]["background-color"]});this.renderMoPlaying()},setNumPages:function(){var a=this.calcNumPages();console.log("num pages is: "+a);this.model.set("num_pages",a)},renderMoPlaying:function(){var a=this.model.get("current_theme");a==="default"&&(a="default-theme");
this.model.get("mo_playing")?$(this.getBody()).css("color",this.themes[a]["mo-color"]):($(this.getBody()).css("color",this.themes[a].color),$(".current-mo-content",this.getBody()).toggleClass("current-mo-content",!1).css("color",""))},renderMoFragHighlight:function(){var a=this.model.get("current_theme");a==="default"&&(a="default-theme");$(".current-mo-content",this.getBody()).toggleClass("current-mo-content",!1).css("color","");var b=this.model.get("current_mo_frag");b&&$("#"+b,this.getBody()).toggleClass("current-mo-content",
!0).css("color",this.themes[a].color)}});
Readium.Views.ScrollingPaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(){Readium.Views.PaginationViewBase.prototype.initialize.call(this);this.page_template=_.template($("#scrolling-page-template").html())},destruct:function(){console.log("Scrolling paginator destructor called");Readium.Views.PaginationViewBase.prototype.destruct.call(this)},render:function(){var a=this,b=this.model.getCurrentSection().toJSON();this.$("#container").html(this.page_template(b));this.$(".content-sandbox").on("load",
function(b){a.iframeLoadCallback(b)});return this},injectLinkHandler:function(a){$("a",a.contentDocument).click(this.linkClickHandler)}});
Readium.Views.ToolbarView=Backbone.View.extend({el:"#toolbar-el",initialize:function(){this.model.on("change:toolbar_visible",this.renderBarVibility,this);this.model.on("change:full_screen",this.renderFullScreen,this);this.model.on("change:current_theme",this.renderThemeButton,this)},render:function(){this.renderBarVibility();this.renderFullScreen();this.renderThemeButton();return this},renderBarVibility:function(){var a=this.model.get("toolbar_visible");this.$("#show-toolbar-button").toggle(!a);
this.$("#top-bar").toggle(a);return this},renderFullScreen:function(){var a=this.model.get("full_screen");this.$("#go-to-fs-ico").toggle(!a);this.$("#leave-fs-ico").toggle(a);return this},renderThemeButton:function(){var a=this.model.get("current_theme")==="night-theme";this.$("#night-to-day-ico").toggle(a);this.$("#day-to-night-ico").toggle(!a);return this},events:{"click #hide-toolbar-button":"hide_toolbar","click #show-toolbar-button":"show_toolbar","click #fs-toggle-btn":"toggle_fs","click #toggle-toc-btn":"toggle_toc",
"click #nightmode-btn":"toggle_night_mode","click #play-mo-btn":"play_mo"},show_toolbar:function(a){a.preventDefault();this.model.set("toolbar_visible",!0)},hide_toolbar:function(a){a.preventDefault();this.model.set("toolbar_visible",!1)},toggle_fs:function(a){a.preventDefault();this.model.toggleFullScreen()},toggle_toc:function(a){a.preventDefault();this.model.toggleToc()},toggle_night_mode:function(){this.model.get("current_theme")==="night-theme"?this.model.set("current_theme","default-theme"):
this.model.set("current_theme","night-theme");this.model.save()},play_mo:function(){this.model.get("mo_playing")?this.model.pauseMo():this.model.playMo(!1)}});
Readium.Views.TocViewBase=Backbone.View.extend({el:"#readium-toc",initialize:function(){this.model.on("change",this.render,this);this.model.on("change:visible",this.setVisibility,this)},events:{"click a":"handleClick","click #close-toc-button":"closeToc"},setVisibility:function(){this.$el.toggle(this.model.get("visible"))},handleClick:function(a){a.preventDefault();href=$(a.target).attr("href");this.model.handleLink(href)},closeToc:function(a){a.preventDefault();this.model.hide()}});
Readium.Views.NcxTocView=Readium.Views.TocViewBase.extend({initialize:function(){Readium.Views.TocViewBase.prototype.initialize.call(this);this.nav_template=_.template($("#ncx-nav-tempate").html())},render:function(){this.setVisibility();for(var a=$("<ol></ol>"),c=this.model.get("navs"),b=0;b<c.length;b++)a.append(this.nav_template(c[b]));this.$("#toc-body").html("<h2>"+(this.model.get("title")||"Contents")+"</h2>");this.$("#toc-body").append(a);this.$("#toc-body").append("<div id='toc-end-spacer'>");
return this}});Readium.Views.XhtmlTocView=Readium.Views.TocViewBase.extend({render:function(){this.$("#toc-body").html(this.model.get("body").html());this.$("#toc-body").append("<div id='toc-end-spacer'>");return this}});
Readium.Views.OptionsView=Backbone.View.extend({el:"#viewer-settings-modal",initialize:function(){this.model.on("change:current_theme",this.renderTheme,this);this.model.on("change:two_up",this.renderUpMode,this);this.model.on("change:current_margin",this.renderMarginRadio,this);this.model.on("change:font_size",this.renderFontSize,this)},render:function(){this.renderTheme();this.renderUpMode();this.renderMarginRadio();this.renderFontSize();return this},renderTheme:function(){this.$("#preview-text")[0].className=
this.model.get("current_theme");return this},renderUpMode:function(){var a=this.model.get("two_up");this.$("#one-up-option").toggleClass("selected",!a);this.$("#two-up-option").toggleClass("selected",a);return this},renderMarginRadio:function(){var a="#margin-option-"+this.model.get("current_margin");this.$(".margin-radio").toggleClass("selected",!1);this.$(a).toggleClass("selected",!0);return this},renderFontSize:function(){var a=this.model.get("font_size"),b=(a/10).toString()+"em";this.$("#preview-text").css("font-size",
b);this.$("#font-size-input").val(a)},events:{"click .theme-option":"selectTheme","click .margin-radio":"selectMargin","click #cancel-settings-but":"cancelSettings","click #save-settings-but":"applySettings","change #font-size-input":"extractFontSize","click #one-up-option":function(){this.model.set("two_up",!1)},"click #two-up-option":function(){this.model.set("two_up",!0)}},extractFontSize:function(){var a=$("#font-size-input").val(),a=parseInt(a,10);this.model.set("font_size",a)},selectTheme:function(a){a=
a.srcElement.id;a==="default-theme-option"&&this.model.set("current_theme","default-theme");a==="night-theme-option"&&this.model.set("current_theme","night-theme");a==="parchment-theme-option"&&this.model.set("current_theme","parchment-theme");a==="ballard-theme-option"&&this.model.set("current_theme","ballard-theme");a==="vancouver-theme-option"&&this.model.set("current_theme","vancouver-theme")},selectMargin:function(a){a=a.srcElement.id;a=a[a.length-1];a==="1"&&this.model.set("current_margin",
1);a==="2"&&this.model.set("current_margin",2);a==="3"&&this.model.set("current_margin",3);a==="4"&&this.model.set("current_margin",4);a==="5"&&this.model.set("current_margin",5)},cancelSettings:function(){this.$el.modal("hide");this.model.resetOptions()},applySettings:function(){this.model.applyOptions();this.$el.modal("hide")}});
Readium.Views.ViewerApplicationView=Backbone.View.extend({el:"body",uiVisible:!1,initialize:function(){this.model.on("change:full_screen",this.toggleFullscreen,this);this.model.on("change:current_theme",this.renderTheme,this);this.model.on("change:toolbar_visible",this.renderPageButtons,this);this.model.on("change:toc_visible",this.renderTocVisible,this);this.optionsPresenter=new Readium.Models.OptionsPresenter({book:this.model});this.optionsView=new Readium.Views.OptionsView({model:this.optionsPresenter});
this.optionsView.render();this.toolbar=new Readium.Views.ToolbarView({model:_book});this.toolbar.render();this.model.on("change:has_toc",this.init_toc,this);this.addGlobalEventHandlers()},toggleFullscreen:function(){this.model.get("full_screen")?document.documentElement.webkitRequestFullScreen():document.webkitCancelFullScreen()},addGlobalEventHandlers:function(){var a=this.model,b=this;window.onresize=function(){a.trigger("repagination_event")};$(document).keydown(function(a){a.which==39&&b.model.goRight();
a.which==37&&b.model.goLeft()});$("#readium-book-view-el").on("swipeleft",function(a){a.preventDefault();b.model.goRight()});$("#readium-book-view-el").on("swiperight",function(a){a.preventDefault();b.model.goLeft()})},render:function(){this.renderTheme();this.renderPageButtons();this.renderTocVisible();return this},renderPageButtons:function(){var a=this.model.get("toolbar_visible");this.$("#prev-page-button").toggle(a);this.$("#next-page-button").toggle(a);return this},renderTheme:function(){var a=
this.model.get("current_theme");this.$el.toggleClass("default-theme","default-theme"===a);this.$el.toggleClass("night-theme","night-theme"===a);this.$el.toggleClass("parchment-theme","parchment-theme"===a);this.$el.toggleClass("ballard-theme","ballard-theme"===a);this.$el.toggleClass("vancouver-theme","vancouver-theme"===a);this.$("#readium-book-view-el").toggleClass("default-theme","default-theme"===a);this.$("#readium-book-view-el").toggleClass("night-theme","night-theme"===a);this.$("#readium-book-view-el").toggleClass("parchment-theme",
"parchment-theme"===a);this.$("#readium-book-view-el").toggleClass("ballard-theme","ballard-theme"===a);this.$("#readium-book-view-el").toggleClass("vancouver-theme","vancouver-theme"===a)},renderTocVisible:function(){this.$el.toggleClass("show-readium-toc",this.model.get("toc_visible"));return this},init_toc:function(){if(this.model.get("has_toc")){var a=this.model.getToc();this.toc=a.TocView();a.fetch()}},events:{"click #prev-page-button":function(){this.model.goLeft()},"click #next-page-button":function(){this.model.goRight()}}});
Readium.Routers.ViewerRouter=Backbone.Router.extend({routes:{"views/viewer.html?book=:key":"openBook","*splat":"splat_handler"},openBook:function(a){Lawnchair(function(){this.get(a,function(a){a===null?alert("Could not load book, try refeshing your browser."):(window._book=new Readium.Models.Ebook(a),window._applicationView=new Readium.Views.ViewerApplicationView({model:window._book}),window._applicationView.render())})})},splat_handler:function(a){console.log(a)}});
